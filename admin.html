<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARTA CSS Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the dark sidebar and content area */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                z-index: 50;
                height: 100%;
                transform: translateX(-100%);
            }
            #sidebar.open {
                transform: translateX(0);
            }
        }
        /* Custom scrollbar for better visual appeal */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Style for the colored table cells in Raw Responses */
        .score-cell {
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
        }
        .score-5 { background-color: #d1fae5; color: #065f46; } /* Green */
        .score-4 { background-color: #fef3c7; color: #b45309; } /* Yellow-Orange */
        .status-active { background-color: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 9999px; font-weight: 500; }
        .status-pending { background-color: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 9999px; font-weight: 500; }

        /* Loader overlay styles */
        .loader-overlay { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.8); z-index: 9999; }
        .loader-wrap { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .loader-spinner { width: 48px; height: 48px; border-radius: 9999px; border: 6px solid rgba(0,0,0,0.08); border-top-color: #2563EB; animation: ds-spin 1s linear infinite; }
        @keyframes ds-spin { to { transform: rotate(360deg); } }
        .loader-text { color: #0f172a; font-weight: 600; }

        /* Modal styles */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
        .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); z-index: 50; max-width: 28rem; width: 90%; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; font-size: 1.125rem; font-weight: 700; color: #111827; }
        .modal-body { padding: 1.5rem; color: #374151; line-height: 1.5; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.75rem; justify-content: flex-end; }
        .modal-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid transparent; font-weight: 500; cursor: pointer; transition: all 0.15s; }
        .modal-btn-primary { background: #2563EB; color: white; }
        .modal-btn-primary:hover { background: #1d4ed8; }
        .modal-btn-secondary { background: #e5e7eb; color: #111827; }
        .modal-btn-secondary:hover { background: #d1d5db; }
        .modal-btn-danger { background: #dc2626; color: white; }
        .modal-btn-danger:hover { background: #b91c1c; }
        .hidden-modal { display: none !important; }

    </style>
    <!-- Libraries for data export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>    </style>
</head>
<body class="font-sans bg-gray-50 antialiased" style="min-height: 100vh;">

    <div id="app" class="min-h-screen">
        <div id="loginView" class="hidden">
            <div class="flex flex-col md:flex-row min-h-screen">
                <div class="md:w-1/2 flex flex-col justify-between p-10 text-white relative overflow-hidden" 
                     style="background: linear-gradient(135deg, #22408D 0%, #1a2f5e 100%);">
                    <!-- Background image with blue overlay -->
                    <div class="absolute inset-0 bg-cover bg-center" 
                         style="background-image: url('Admin Side/Nav Admin/city-hall.jpg');"></div>
                    <div class="absolute inset-0 bg-blue-600 opacity-50"></div>
                    
                    <!-- Content positioned absolutely to be on top of overlay -->
                    <div class="relative z-10 flex flex-col h-full justify-center items-center gap-20">
                        <h1 class="text-6xl font-extrabold drop-shadow-lg">ARTA CSS System</h1>
                        <div class="flex justify-center items-center">
                            <img src="Admin Side/Nav Admin/val-logo.png" alt="Valenzuela City Logo" class="w-86 h-86 md:w-94 md:h-94 drop-shadow-lg object-contain">
                        </div>
                        <p class="text-sm text-center drop-shadow-lg">Authorized personnel only. All access is monitored.</p>
                    </div>
                </div>

                <div class="md:w-1/2 flex items-center justify-center p-8 md:p-16 bg-white">
                    <div class="w-full max-w-md">
                        <h2 class="text-5xl font-extrabold text-gray-800 mb-10 text-center">Log In</h2>
                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label for="email" class="block text-lg font-medium text-gray-700">Email:</label>
                                <div class="mt-2 relative rounded-xl shadow-md">
                                    <input type="email" id="email" name="email" required placeholder="youremail@email.com"
                                           class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900 pr-12">
                                    <span class="absolute right-0 top-0 mt-3 mr-4 text-gray-400">
                                        <i data-lucide="mail" class="w-5 h-5"></i>
                                    </span>
                                </div>
                                <div id="emailError" class="text-red-600 text-sm mt-1 hidden"></div>
                            </div>
                            <div>
                                <label for="password" class="block text-lg font-medium text-gray-700">Password:</label>
                                <div class="mt-2 relative rounded-xl shadow-md">
                                    <input type="password" id="password" name="password" required
                                           class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900 pr-12">
                                    <span class="absolute right-0 top-0 mt-3 mr-4 text-gray-400">
                                        <i data-lucide="lock" class="w-5 h-5"></i>
                                    </span>
                                </div>
                                <div id="passwordError" class="text-red-600 text-sm mt-1 hidden"></div>
                                <div class="text-sm mt-2 text-right">
                                    <button type="button" id="forgotPasswordLink" class="text-sm font-medium text-blue-600 hover:text-blue-500 bg-transparent border-none cursor-pointer">
                                        Forgot password?
                                    </button>
                                </div>
                            </div>
                            <div id="loginError" class="text-red-600 text-center hidden"></div>
                            <div class="pt-4">
                                <button type="submit"
                                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-xl text-lg font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                                    Log In
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboardView" class="hidden min-h-screen flex flex-col">
            <header class="flex items-center justify-between p-4 bg-white shadow-md z-40 fixed w-full top-0">
                <div class="flex items-center space-x-4">
                    <button id="menu-toggle" class="md:hidden p-2 text-gray-600 hover:text-gray-900 rounded-full hover:bg-gray-100">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <div class="flex items-center justify-center flex-shrink-0">
                        <img src="Admin Side/Nav Admin/footerlogo.png" alt="" class="w-12 h-12 object-contain"> 
                    </div>
                    
                    <div class="hidden sm:block flex items-center justify-center flex-shrink-0">
                         <img src="Admin Side/Nav Admin/text.png" alt="" class="w-32 h-12 object-contain"> 
                    </div>
                    <h1 class="text-xl font-semibold text-gray-800 hidden md:block">ARTA Customer Satisfaction Survey Dashboard</h1>
                </div>
                <div id="userMenu" class="relative">
                    <button id="userMenuButton" class="flex items-center space-x-2 cursor-pointer p-2 rounded-xl bg-blue-50 hover:bg-blue-100 transition duration-150">
                        <div class="w-10 h-10 p-2 rounded-full flex-shrink-0">
                             <img src="Admin Side/Nav Admin/admin.png" alt="" class="w-full h-full object-contain">
                        </div>
                        <span class="hidden sm:inline font-medium text-gray-700">Admin</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                    </button>

                    <div id="userDropdown" class="hidden absolute right-0 mt-2 w-40 bg-white shadow-lg rounded-md z-50 ring-1 ring-black ring-opacity-5">
                        <div class="py-1">
                            <button id="logoutBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Logout</button>
                        </div>
                    </div>
                </div>
            </header>

            <div class="flex flex-grow pt-20">
                <aside id="sidebar" class="bg-[#0b296b] pt-4 text-white w-64 md:w-64 flex-shrink-0 md:relative md:translate-x-0">
                    <div class="p-6">
                        <h2 class="text-xl font-bold mb-1">ARTA CSS</h2>
                        <p class="text-sm opacity-75">CONTROL CENTER</p>
                    </div>
                    <nav class="space-y-1 p-3">
                        <a href="#" data-view="dashboard" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out bg-white text-[#0b296b] shadow-lg">
                            <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                            Dashboard
                        </a>
                        <a href="#" data-view="raw-responses" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out hover:bg-[#1f3f80] text-gray-200">
                            <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                            Raw Responses
                        </a>
                        <a href="#" data-view="compliance-reports" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out hover:bg-[#1f3f80] text-gray-200">
                            <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                            Compliance Reports
                        </a>
                        <a href="#" data-view="manage-questions" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out hover:bg-[#1f3f80] text-gray-200">
                            <i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i>
                            Manage Questions
                        </a>
                        <a href="#" data-view="user-management" class="nav-link flex items-center p-3 rounded-xl transition duration-150 ease-in-out hover:bg-[#1f3f80] text-gray-200">
                            <i data-lucide="user-cog" class="w-5 h-5 mr-3"></i>
                            User Management
                        </a>
                    </nav>
                </aside>

                <main id="content-area" class="flex-grow p-4 md:p-8 overflow-y-auto bg-gray-50 pt-4">
                    <div id="dashboard" class="page-content hidden">
                        <div class="mb-8">
                            <h2 class="text-3xl font-extrabold text-gray-900">System Analytics Overview</h2>
                            <p class="text-gray-500 mt-1">Welcome to the ARTA Customer Satisfaction Survey Admin Dashboard for Valenzuela City.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                                <p class="text-lg font-medium text-gray-500">TOTAL RESPONSES</p>
                                <div class="flex items-center justify-between mt-1">
                                    <h3 id="totalResponses" class="text-2xl font-extrabold text-gray-800">0</h3>
                                    <div class="p-3 bg-red-100 text-red-600 rounded-full">
                                        <i data-lucide="file-bar-chart-2" class="w-6 h-6"></i>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-400 mt-2">Real-time Response Count from Firestore</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                                <p class="text-lg font-medium text-gray-500">AVG SATISFACTION</p>
                                <div class="flex items-center justify-between mt-1">
                                    <h3 id="avgSatisfaction" class="text-2xl font-extrabold text-gray-800">0.0 / 5</h3>
                                    <div class="p-3 bg-yellow-100 text-yellow-600 rounded-full">
                                        <i data-lucide="star" class="w-6 h-6"></i>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-400 mt-2">Average SQD rating across all submissions</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                                <p class="text-lg font-medium text-gray-500">MOST AVAILED SERVICE</p>
                                <div class="mt-1">
                                    <h3 id="mostAvailedService" class="text-2xl font-bold text-gray-900">No data</h3>
                                </div>
                                <p class="text-sm text-gray-400 mt-2">Most frequently selected service</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                                <p class="text-lg font-medium text-gray-500">CLIENT TYPE</p>
                                <div class="flex items-center justify-between mt-1">
                                    <h3 id="clientTypeSummary" class="text-2xl font-extrabold text-gray-900">â€”</h3>
                                    <div class="p-3 bg-blue-100 text-blue-600 rounded-full">
                                        <i data-lucide="users" class="w-6 h-6"></i>
                                    </div>
                                </div>
                                <p id="clientTypeSub" class="text-sm text-gray-400 mt-2">Distribution: Citizen / Business / Government</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center mb-4 text-blue-800">
                                    <i data-lucide="trending-up" class="w-6 h-6 mr-2"></i>
                                    <h4 class="text-lg font-bold">Average Rating per Service (Metric 1)</h4>
                                </div>
                                <p class="text-sm text-gray-500 mb-4">Service Quality Performance Metrics Using ARTA SQD Scores.</p>
                                <div class="h-80">
                                    <canvas id="serviceChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center mb-4 text-blue-800">
                                    <i data-lucide="pie-chart" class="w-6 h-6 mr-2"></i>
                                    <h4 class="text-lg font-bold">Client Type Distribution (Metric 2)</h4>
                                </div>
                                <p class="text-sm text-gray-500 mb-4">Survey Respondent Breakdown for Data Segmentation</p>
                                <div class="h-80 flex items-center justify-center">
                                    <canvas id="clientTypeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="raw-responses" class="page-content hidden">
                        <h2 class="text-3xl font-extrabold text-gray-900">Raw Response Data</h2>
                        <p class="text-gray-500 mt-1 mb-6">Includes all submissions, integrating data from survey platforms.</p>
                        
                        <!-- Inline Filter Section -->
                        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                            <div class="mb-4 flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Filter Responses</h3>
                                <div id="filterStatusBadge" class="text-sm text-gray-600 bg-blue-100 px-3 py-1 rounded-lg hidden border border-blue-300">
                                    <span id="filterStatusText"></span>
                                </div>
                            </div>
                            
                            <form id="filterForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                                <!-- Date Range Start -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input type="date" id="filterStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                                </div>
                                
                                <!-- Date Range End -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input type="date" id="filterEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                                </div>
                                
                                <!-- Region of Residence -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                                    <select id="filterRegion" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">All Regions</option>
                                        <option value="Region I - Ilocos Region">Region I - Ilocos Region</option>
                                        <option value="Region II - Cagayan Valley">Region II - Cagayan Valley</option>
                                        <option value="Region III - Central Luzon">Region III - Central Luzon</option>
                                        <option value="Region IV-A - CALABARZON">Region IV-A - CALABARZON</option>
                                        <option value="Region IV-B - MIMAROPA">Region IV-B - MIMAROPA</option>
                                        <option value="Region V - Bicol Region">Region V - Bicol Region</option>
                                        <option value="Region VI - Western Visayas">Region VI - Western Visayas</option>
                                        <option value="Region VII - Central Visayas">Region VII - Central Visayas</option>
                                        <option value="Region VIII - Eastern Visayas">Region VIII - Eastern Visayas</option>
                                        <option value="Region IX - Zamboanga Peninsula">Region IX - Zamboanga Peninsula</option>
                                        <option value="Region X - Northern Mindanao">Region X - Northern Mindanao</option>
                                        <option value="Region XI - Davao Region">Region XI - Davao Region</option>
                                        <option value="Region XII - Soccsksargen">Region XII - Soccsksargen</option>
                                        <option value="Region XIII - Caraga">Region XIII - Caraga</option>
                                        <option value="BARMM - Bangsamoro Autonomous Region">BARMM - Bangsamoro Autonomous Region</option>
                                        <option value="NCR - National Capital Region">NCR - National Capital Region</option>
                                    </select>
                                </div>
                                
                                <!-- Client Type -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Client Type</label>
                                    <select id="filterClientType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="">All Types</option>
                                        <option value="citizen">Citizen</option>
                                        <option value="business">Business</option>
                                        <option value="OFW">OFW</option>
                                        <option value="government">Government</option>
                                    </select>
                                </div>
                                
                                <!-- Min Score -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Min Score</label>
                                    <input type="number" id="filterMinScore" min="0" max="5" step="0.1" placeholder="0.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                                </div>
                            </form>
                            
                            <!-- Filter Buttons -->
                            <div class="flex gap-2">
                                <button type="button" id="clearFiltersBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg transition duration-150 ease-in-out flex items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    Clear Filters
                                </button>
                            </div>
                        </div>

                        <!-- Scrollable Table Container -->
                        <div class="bg-white rounded-xl shadow-lg">
                            <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DATE/TIME</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">REGION OF RESIDENCE</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CLIENT/TYPE</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SQD SCORE (Avg)</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">CITIZEN CHARTER AWARE</th>
                                        </tr>
                                    </thead>
                                    <tbody id="raw-responses-tbody" class="divide-y divide-gray-200">
                                        <tr class="hover:bg-gray-50">
                                            <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">Loading data from Firestore...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="bg-gray-50 px-6 py-3 border-t border-gray-200 text-sm text-gray-600">
                                Showing <span id="totalRecords">0</span> records
                            </div>
                        </div>
                    </div>

                    <div id="compliance-reports" class="page-content hidden">
                        <h2 class="text-3xl font-extrabold text-gray-900">Export & Reports</h2>
                        <p class="text-gray-500 mt-1 mb-6">Generate official ARTA compliance reports and export data for further analysis.</p>

                        <div class="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-600 mb-6">
                            <p class="font-medium text-blue-800">ARTA Compliance Notice: All reports follow the official ARTA metrics required for submission.</p>
                        </div>

                        <div class="space-y-6">
                            <div class="flex items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Export All Responses (CSV)</h3>
                                    <p class="text-sm text-gray-500">Download raw dataset for analysis in tools like Excel.</p>
                                </div>
                                <button id="exportAllCsvBtn" class="flex items-center bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">
                                    <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                                    Export CSV
                                </button>
                            </div>
                            <div class="flex items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">ARTA Compliance Report (PDF)</h3>
                                    <p class="text-sm text-gray-500">Generate official ARTA compliant report with analytics and metrics for quarterly submission.</p>
                                </div>
                                <button id="downloadPdfBtn" class="flex items-center bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">
                                    <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                                    Download PDF
                                </button>
                            </div>
                            <div class="flex items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">Generate Comprehensive ARTA Report</h3>
                                    <p class="text-sm text-gray-500">Create comprehensive ARTA submission report with all required metrics and citizen feedback analysis.</p>
                                </div>
                                <button id="generateReportBtn" class="flex items-center bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">
                                    <i data-lucide="award" class="w-5 h-5 mr-2"></i>
                                    Generate Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="manage-questions" class="page-content hidden">
                        <h2 class="text-3xl font-extrabold text-gray-900">Manage Survey Questions</h2>
                        <p class="text-gray-500 mt-1 mb-6">Configure ARTA Customer Satisfaction Survey questions.</p>

                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Question List</h3>
                            <div class="flex gap-3">
                                <button id="setupQuestionsBtn" class="flex items-center bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">
                                    <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                                    Load Default Questions
                                </button>
                                <button id="addQuestionBtn" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-150">
                                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                    Add CGOV Question
                                </button>
                            </div>
                        </div>

                        <div id="questionsContainerWrapper" class="max-h-[60vh] overflow-y-auto pr-3">
                            <div id="questionsContainer" class="space-y-4">
                                <!-- Questions will be dynamically loaded here -->
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-600 mt-6">
                            <p class="text-sm text-blue-800">The questions are ARTA-compliant and necessary for official reports; modifications must adhere to Anti-Red tape Authority standards.</p>
                        </div>
                    </div>

                    <div id="user-management" class="page-content hidden">
                        <h2 class="text-3xl font-extrabold text-gray-900">User Management</h2>
                        <p class="text-gray-500 mt-1 mb-6">Manage admin users and assign role-based access control (RBAC).</p>

                        <button id="showAddUserBtn" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl transition duration-150 mb-6">
                            <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>
                            Add User
                        </button>

                        <h3 class="text-xl font-bold text-gray-800 mb-4">Existing Users</h3>
                        
                        <div class="overflow-x-auto bg-white rounded-xl shadow-lg p-4 mb-8">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NAME</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EMAIL</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ROLE</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <!-- Admin users loaded from Firestore dynamically -->
                                </tbody>
                            </table>
                        </div>

                        <h3 class="text-xl font-bold text-gray-800 mb-4">Role Permissions</h3>
                        
                        <div class="space-y-4">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Admin</h4>
                                <p class="text-gray-600 text-sm">Full Operational Access. Includes User Management, Manage Questions, Raw Responses, and Compliance Reports. Excludes System Settings.</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Data Analyst</h4>
                                <p class="text-gray-600 text-sm">Data & Reporting Modules Only. Includes Dashboard, Raw Responses, and Compliance Reports.</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Survey Manager</h4>
                                <p class="text-gray-600 text-sm">Content Management Only. Primarily Manage Questions. May include access to the Dashboard for results overview.</p>
                            </div>
                        </div>
                    </div>

                    <div id="add-user-form" class="page-content hidden">
                        <div class="flex flex-col md:flex-row min-h-[calc(100vh-8rem)]"> 
                            <div class="md:w-1/2 flex flex-col justify-between p-10 text-white relative overflow-hidden rounded-xl shadow-xl" 
                                 style="background: linear-gradient(135deg, #22408D 0%, #1a2f5e 100%);">
                                <!-- Background image with blue overlay -->
                                <div class="absolute inset-0 bg-cover bg-center" 
                                     style="background-image: url('Admin Side/Nav Admin/city-hall.jpg');"></div>
                                <div class="absolute inset-0 bg-blue-600 opacity-50"></div>
                                
                                <!-- Content positioned absolutely to be on top of overlay -->
                                <div class="relative z-10 flex flex-col h-full justify-center items-center gap-20">
                                    <h1 class="text-6xl font-extrabold drop-shadow-lg">ARTA CSS System</h1>
                                    <div class="flex justify-center items-center">
                                        <img src="Admin Side/Nav Admin/val-logo.png" alt="Valenzuela City Logo" class="w-86 h-86 md:w-94 md:h-94 drop-shadow-lg object-contain">
                                    </div>
                                    <p class="text-sm text-center drop-shadow-lg">Authorized personnel only. All access is monitored.</p>
                                </div>
                            </div>

                            <div class="md:w-1/2 flex items-center justify-center p-8 md:p-16 bg-white rounded-xl shadow-xl md:ml-6 mt-6 md:mt-0">
                                <div class="w-full max-w-md">
                                    <h2 class="text-5xl font-extrabold text-gray-800 mb-10 text-center">Add User</h2>
                                    <form id="addUserForm" class="space-y-6">
                                        <div class="flex space-x-4">
                                            <div class="w-1/2">
                                                <label for="firstName" class="block text-lg font-medium text-gray-700">First Name:</label>
                                                <input type="text" id="firstName" name="firstName" required 
                                                       class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900" 
                                                       aria-label="First Name">
                                                <p id="firstNameError" class="text-red-500 text-sm mt-1 hidden">First name is required.</p>
                                            </div>
                                            <div class="w-1/2">
                                                <label for="lastName" class="block text-lg font-medium text-gray-700">Last Name:</label>
                                                <input type="text" id="lastName" name="lastName" required 
                                                       class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900"
                                                       aria-label="Last Name">
                                                <p id="lastNameError" class="text-red-500 text-sm mt-1 hidden">Last name is required.</p>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="userEmail" class="block text-lg font-medium text-gray-700">Email:</label>
                                            <div class="mt-2 relative rounded-xl shadow-md">
                                                <input type="email" id="userEmail" name="userEmail" required placeholder="e.g. juandelacruz@gmail.com"
                                                       class="w-full px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900 pr-12">
                                                <span class="absolute right-0 top-0 mt-3 mr-4 text-gray-400">
                                                    <i data-lucide="mail" class="w-5 h-5"></i>
                                                </span>
                                            </div>
                                            <p id="emailError" class="text-red-500 text-sm mt-1 hidden">Enter a valid email address.</p>
                                        </div>

                                        <div>
                                            <label for="userRole" class="block text-lg font-medium text-gray-700">Role</label>
                                            <div class="mt-2 relative">
                                                <select id="userRole" name="userRole" required
                                                        class="w-full px-5 py-3 appearance-none border-2 border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-gray-900 cursor-pointer pr-12 bg-white">
                                                    <option value="" disabled selected>Select a role</option>
                                                    <option value="admin">Admin</option>
                                                    <option value="data_analyst">Data Analyst</option>
                                                    <option value="survey_manager">Survey Manager</option>
                                                </select>
                                                <span class="absolute right-0 top-0 mt-3 mr-4 text-gray-400 pointer-events-none">
                                                    <i data-lucide="chevron-down" class="w-5 h-5"></i>
                                                </span>
                                            </div>
                                            <p id="roleError" class="text-red-500 text-sm mt-1 hidden">Please select a role.</p>
                                        </div>

                                        <div class="pt-4">
                                            <button type="submit"
                                                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-xl text-lg font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                                                Invite User
                                            </button>
                                            <p id="goBackBtn" class="text-sm mt-4 text-center text-gray-600 hover:text-blue-600 cursor-pointer">
                                                &larr; Go Back
                                            </p>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>



                    </main>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-900 mb-4" id="modalTitle">Confirm Action</h2>
            <p class="text-gray-600 mb-6" id="modalMessage">Are you sure you want to proceed with this action?</p>
            
            <div class="flex gap-4">
                <button id="confirmBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-150">
                    Proceed
                </button>
                <button id="cancelBtn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-4 rounded-xl transition duration-150">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Question Modal -->
    <div id="editQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 my-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Edit Question</h2>
            
            <form id="editQuestionForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Code</label>
                    <input type="text" id="editQuestionCode" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" readonly>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Text</label>
                    <textarea id="editQuestionText" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 h-24" required></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Type</label>
                    <select id="editQuestionType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="SQD">SQD Metric</option>
                        <option value="CC">CC Metric</option>
                    </select>
                </div>

                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="editQuestionRequired" class="w-4 h-4 text-blue-600 rounded">
                        <span class="ml-2 text-sm text-gray-700">Required Question</span>
                    </label>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Save Changes
                    </button>
                    <button type="button" id="closeEditModal" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="addQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 my-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Add New Question</h2>
            
            <form id="addQuestionForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Code</label>
                    <input type="text" id="newQuestionCode" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., SDQ1, CC2" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Text</label>
                    <textarea id="newQuestionText" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Enter the question text" required></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Type</label>
                    <select id="newQuestionType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="SQD">SQD Metric</option>
                        <option value="CC">CC Metric</option>
                    </select>
                </div>

                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="newQuestionRequired" class="w-4 h-4 text-blue-600 rounded" checked>
                        <span class="ml-2 text-sm text-gray-700">Required Question</span>
                    </label>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Add Question
                    </button>
                    <button type="button" id="closeAddModal" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="setup-survey-questions.js"></script>
    <script type="module">
        // --- Firestore Integration ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, getDocs, doc, getDoc, setDoc, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-functions.js";
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlmbelcBvE8T-j2_bCeam5oGR7g3zhLz8",
            authDomain: "daisysyete-c9511.firebaseapp.com",
            projectId: "daisysyete-c9511",
            storageBucket: "daisysyete-c9511.firebasestorage.app",
            messagingSenderId: "84742185648",
            appId: "1:84742185648:web:05d506b26a2b725644d175",
            measurementId: "G-0H67RTVBTQ"
        };

        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        const auth = getAuth(firebaseApp);
        const functions = getFunctions(firebaseApp, 'us-central1');

        console.log('[admin.html] Firebase initialized, project:', firebaseConfig.projectId);

        // Store Firestore references globally for use in other scripts
        window.db = db;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.query = query;
        window.where = where;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.auth = auth;
        window.functions = functions;
        window.httpsCallable = httpsCallable;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.sendEmailVerification = sendEmailVerification;
        window.FIREBASE_API_KEY = firebaseConfig.apiKey;
        window.allSurveyResponses = []; // Store all responses for export functions

        // Helper function to safely update DOM elements
        function safeUpdateElement(id, value) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value;
            } else {
                console.warn(`Element with id '${id}' not found`);
            }
        }

        // --- ADMIN AUTHENTICATION ---
        // Function to validate admin credentials against Firestore
        async function validateAdminLogin(email, password) {
            try {
                // First try to sign in with Firebase Auth
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;


                // Primary check: try to read admin document by UID (this matches security rules
                // that require admin_documents to be keyed by the user's UID).
                try {
                    const adminDocRef = doc(db, 'admin_users', user.uid);
                    const adminDocSnap = await getDoc(adminDocRef);
                    if (adminDocSnap.exists()) {
                        const adminData = adminDocSnap.data();
                        
                        // Check status - must be 'active' to login
                        if (adminData.status !== 'active') {
                            return { success: false, message: 'Your account is pending activation. Please ask your super admin to activate your account in the User Management tab.' };
                        }
                        
                        return {
                            success: true,
                            user: {
                                email: user.email,
                                uid: user.uid,
                                role: adminData.role || 'admin',
                                first_name: adminData.first_name || '',
                                last_name: adminData.last_name || '',
                                name: `${adminData.first_name || ''} ${adminData.last_name || ''}`.trim() || 'Admin User',
                                permissions: adminData.permissions || []
                            }
                        };
                    }
                } catch (uidErr) {
                    // Log and continue to fallback query by email
                    console.warn('UID lookup failed or blocked by rules, will fallback to email query', uidErr && uidErr.code ? uidErr.code : uidErr);
                }

                // Fallback: some projects store admin documents keyed by auto-id or email
                // Query admin_users collection by email as a fallback (may be blocked by strict rules)
                const adminUsersRef = collection(db, "admin_users");
                const q = query(adminUsersRef, where("email", "==", email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.warn("User not found in admin_users collection");
                    return { success: false, message: "Your account has not been set up yet. Please contact the Super Admin to activate your account." };
                }

                const adminData = querySnapshot.docs[0].data();
                
                // Check status - must be 'active' to login
                if (adminData.status !== 'active') {
                    return { success: false, message: 'Your account is pending activation. Please ask your super admin to activate your account in the User Management tab.' };
                }

                return {
                    success: true,
                    user: {
                        email: user.email,
                        uid: user.uid,
                        role: adminData.role || "admin",
                        first_name: adminData.first_name || '',
                        last_name: adminData.last_name || '',
                        name: `${adminData.first_name || ''} ${adminData.last_name || ''}`.trim() || 'Admin User',
                        permissions: adminData.permissions || []
                    }
                };
            } catch (error) {
                console.error("Login error:", error && error.code ? error.code : error, error && error.message ? error.message : error);

                // Map known Firebase error codes to user-friendly messages
                if (error && error.code) {
                    switch(error.code) {
                        case "auth/invalid-email":
                            return { success: false, message: "Invalid email format." };
                        case "auth/user-disabled":
                            return { success: false, message: "This account has been disabled." };
                        case "auth/user-not-found":
                            return { success: false, message: "Email not found. Invalid credentials." };
                        case "auth/wrong-password":
                            return { success: false, message: "Incorrect password." };
                        case "auth/too-many-requests":
                            return { success: false, message: "Too many failed login attempts. Try again later." };
                        case "permission-denied":
                            return { success: false, message: "Server permission denied when checking admin role. Verify Firestore rules and admin_users document ID (should be the user UID)." };
                        default:
                            return { success: false, message: "Invalid email or password." };
                    }
                }

                return { success: false, message: "Invalid email or password." };
            }
        }

        // Expose the function to non-module scripts (login handler in plain <script> needs access)
        window.validateAdminLogin = validateAdminLogin;

        // Initialize real-time listeners with a slight delay to ensure DOM is ready
        setTimeout(() => {
            const surveyResponsesRef = collection(db, "survey_responses");

            // Listen for survey responses in real-time
            onSnapshot(surveyResponsesRef, (snapshot) => {
                const responses = [];
                snapshot.forEach((doc) => {
                    responses.push({ id: doc.id, ...doc.data() });
                });
                
                // Store responses globally for export functions and filtering
                window.allSurveyResponses = responses;
                setResponsesToFilter(responses);
                
                console.log('Firestore data received:', responses);
                
                // Update metrics with aggregated data
                updateMetrics(responses);
                updateCharts(responses);
            }, (error) => {
                console.error('Firestore listener error:', error);
            });
        }, 100);

        /**
         * Aggregates response data and updates metric placeholders
         * @param {Array} responses - Array of response documents from Firestore
         */
        function updateMetrics(responses) {
            if (!responses || responses.length === 0) {
                safeUpdateElement('totalResponses', '0');
                safeUpdateElement('avgSatisfaction', '0.0 / 5');
                safeUpdateElement('mostAvailedService', 'No data');
                safeUpdateElement('clientTypeSummary', 'â€”');
                return;
            }

            const totalResponses = responses.length;
            let totalSqdSum = 0;
            let totalSqdCount = 0;
            const serviceMap = {};
            const clientTypeCounts = { Citizen: 0, Business: 0, Government: 0 };

            responses.forEach(doc => {
                // Aggregate SQD scores from serviceQuality object
                const sq = doc.serviceQuality || {};
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) {
                        totalSqdSum += v;
                        totalSqdCount += 1;
                    }
                });

                // Track services
                const svc = (doc.serviceAvailed || 'Unknown').trim() || 'Unknown';
                if (!serviceMap[svc]) serviceMap[svc] = { count: 0 };
                serviceMap[svc].count += 1;

                // Track client types
                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                if (ctRaw.includes('citizen')) clientTypeCounts.Citizen += 1;
                else if (ctRaw.includes('business')) clientTypeCounts.Business += 1;
                else if (ctRaw.includes('government')) clientTypeCounts.Government += 1;
            });

            const avgSqd = totalSqdCount > 0 ? (totalSqdSum / totalSqdCount) : 0;
            let mostAvailed = 'No data';
            let maxCount = 0;
            Object.keys(serviceMap).forEach(svc => {
                if (serviceMap[svc].count > maxCount) {
                    maxCount = serviceMap[svc].count;
                    mostAvailed = svc;
                }
            });

            // Update metric elements
            safeUpdateElement('totalResponses', totalResponses.toString());
            safeUpdateElement('avgSatisfaction', `${avgSqd.toFixed(1)} / 5`);
            safeUpdateElement('mostAvailedService', mostAvailed);

            const total = totalResponses;
            const pct = (n) => ((n / total) * 100).toFixed(0) + '%';
            safeUpdateElement('clientTypeSummary', `Citizen ${pct(clientTypeCounts.Citizen)} â€¢ Business ${pct(clientTypeCounts.Business)} â€¢ Govt ${pct(clientTypeCounts.Government)}`);
        }

        /**
         * Updates charts with real-time response data
         * @param {Array} responses - Array of response documents from Firestore
         */
        function updateCharts(responses) {
            if (!responses || responses.length === 0) return;

            const totalResponses = responses.length;
            const serviceMap = {};
            const clientTypeCounts = { Citizen: 0, Business: 0, Government: 0 };

            responses.forEach(doc => {
                // Aggregate service SQD scores
                const svc = (doc.serviceAvailed || 'Unknown').trim() || 'Unknown';
                const sq = doc.serviceQuality || {};
                if (!serviceMap[svc]) serviceMap[svc] = { sumScore: 0, countScore: 0 };
                
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) {
                        serviceMap[svc].sumScore += v;
                        serviceMap[svc].countScore += 1;
                    }
                });

                // Aggregate client types
                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                if (ctRaw.includes('citizen')) clientTypeCounts.Citizen += 1;
                else if (ctRaw.includes('business')) clientTypeCounts.Business += 1;
                else if (ctRaw.includes('government')) clientTypeCounts.Government += 1;
            });

            // Prepare service chart data
            const serviceLabels = Object.keys(serviceMap);
            const serviceData = serviceLabels.map(svc => {
                const avg = serviceMap[svc].countScore > 0 ? (serviceMap[svc].sumScore / serviceMap[svc].countScore) : 0;
                return parseFloat(avg.toFixed(2));
            });

            // Update service chart
            if (window.serviceChartInstance) {
                window.serviceChartInstance.data.labels = serviceLabels;
                window.serviceChartInstance.data.datasets[0].data = serviceData;
                window.serviceChartInstance.update();
            }

            // Update client type chart
            if (window.clientTypeChartInstance) {
                window.clientTypeChartInstance.data.datasets[0].data = [clientTypeCounts.Citizen, clientTypeCounts.Business, clientTypeCounts.Government];
                window.clientTypeChartInstance.update();
            }
        }

        /**
         * Updates the raw responses table with real-time data
         * @param {Array} responses - Array of response documents from Firestore
         */
        function updateResponsesTable(responses) {
            const tableBody = document.querySelector('#raw-responses tbody');
            if (!tableBody) return;

            if (responses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No survey responses yet</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            responses.slice(0, 10).forEach((doc, index) => {
                const sq = doc.serviceQuality || {};
                let sqSum = 0, sqCount = 0;
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) { sqSum += v; sqCount += 1; }
                });
                const avgSqd = sqCount > 0 ? (sqSum / sqCount) : 0;

                const submittedAt = doc.submittedAt ? new Date(doc.submittedAt.toDate ? doc.submittedAt.toDate() : doc.submittedAt).toLocaleString() : 'N/A';
                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                const isCitizen = ctRaw.includes('citizen');
                const ccAwere = doc.citizensCharter && doc.citizensCharter.cc1 !== '4' ? 'Yes' : 'No';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${String(index + 1).padStart(3, '0')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${submittedAt}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.regionOfResidence || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${isCitizen ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${doc.clientType || 'Unknown'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <span class="score-cell ${avgSqd >= 4.5 ? 'score-5' : 'score-4'}">
                            ${avgSqd.toFixed(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center ${ccAwere === 'Yes' ? 'text-blue-600' : 'text-red-600'} font-semibold">
                        ${ccAwere}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Expose update functions globally for use in main script
        window.updateMetrics = updateMetrics;
        window.updateCharts = updateCharts;
        window.updateResponsesTable = updateResponsesTable;

        /**
         * FILTERING SYSTEM FOR RAW RESPONSES
         * Client-side filtering to avoid Firestore index requirements
         */

        let allResponses = []; // Store all responses for filtering

        // Render all filtered responses in scrollable table
        function renderFilteredTable(responses) {
            const tableBody = document.getElementById('raw-responses-tbody');
            if (!tableBody) return;

            document.getElementById('totalRecords').textContent = responses.length;

            if (responses.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No responses match your filters</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            responses.forEach((doc, idx) => {
                const sq = doc.serviceQuality || {};
                let sqSum = 0, sqCount = 0;
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) { sqSum += v; sqCount += 1; }
                });
                const avgSqd = sqCount > 0 ? (sqSum / sqCount) : 0;

                const submittedAt = doc.submittedAt ? new Date(doc.submittedAt.toDate ? doc.submittedAt.toDate() : doc.submittedAt).toLocaleString() : 'N/A';
                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                const isCitizen = ctRaw.includes('citizen');
                const ccAwere = doc.citizensCharter && doc.citizensCharter.cc1 !== '4' ? 'Yes' : 'No';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${String(idx + 1).padStart(3, '0')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${submittedAt}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.regionOfResidence || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${isCitizen ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${doc.clientType || 'Unknown'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <span class="score-cell ${avgSqd >= 4.5 ? 'score-5' : 'score-4'}">
                            ${avgSqd.toFixed(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center ${ccAwere === 'Yes' ? 'text-blue-600' : 'text-red-600'} font-semibold">
                        ${ccAwere}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Apply filters from form
        async function applyFilters() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const region = document.getElementById('filterRegion').value;
            const clientType = document.getElementById('filterClientType').value;
            const minScore = parseFloat(document.getElementById('filterMinScore').value) || 0;

            let filtered = allResponses.filter(doc => {
                // Date range filter
                if (startDate) {
                    const filterDate = new Date(startDate);
                    const docDate = doc.submittedAt ? new Date(doc.submittedAt.toDate ? doc.submittedAt.toDate() : doc.submittedAt) : null;
                    if (!docDate || docDate < filterDate) return false;
                }
                if (endDate) {
                    const filterDate = new Date(endDate);
                    filterDate.setHours(23, 59, 59, 999);
                    const docDate = doc.submittedAt ? new Date(doc.submittedAt.toDate ? doc.submittedAt.toDate() : doc.submittedAt) : null;
                    if (!docDate || docDate > filterDate) return false;
                }

                // Region filter
                if (region && doc.regionOfResidence !== region) return false;

                // Client type filter
                if (clientType) {
                    const responseType = (doc.clientType || '').toLowerCase();
                    if (!responseType.includes(clientType.toLowerCase())) return false;
                }

                // Score filter
                const sq = doc.serviceQuality || {};
                let sqSum = 0, sqCount = 0;
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) { sqSum += v; sqCount += 1; }
                });
                const avgScore = sqCount > 0 ? (sqSum / sqCount) : 0;
                if (avgScore < minScore) return false;

                return true;
            });

            renderFilteredTable(filtered);
            updateFilterBadge();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('filterForm').reset();
            document.getElementById('filterStatusBadge').classList.add('hidden');
            renderFilteredTable(allResponses);
        }

        // Update filter status badge
        function updateFilterBadge() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const region = document.getElementById('filterRegion').value;
            const clientType = document.getElementById('filterClientType').value;
            const minScore = document.getElementById('filterMinScore').value;

            const activeFilters = [];
            if (startDate || endDate) activeFilters.push('Date');
            if (region) activeFilters.push('Region');
            if (clientType) activeFilters.push('Type');
            if (minScore && parseFloat(minScore) > 0) activeFilters.push('Score');

            if (activeFilters.length > 0) {
                document.getElementById('filterStatusText').textContent = `${activeFilters.length} filter(s) active`;
                document.getElementById('filterStatusBadge').classList.remove('hidden');
            } else {
                document.getElementById('filterStatusBadge').classList.add('hidden');
            }
        }

        // Event listeners for automatic filtering
        document.addEventListener('DOMContentLoaded', () => {
            const filterForm = document.getElementById('filterForm');
            const clearBtn = document.getElementById('clearFiltersBtn');

            // Get all filter inputs
            const filterInputs = [
                document.getElementById('filterStartDate'),
                document.getElementById('filterEndDate'),
                document.getElementById('filterRegion'),
                document.getElementById('filterClientType'),
                document.getElementById('filterMinScore')
            ];

            // Add event listeners to all filter inputs
            filterInputs.forEach(input => {
                if (input) {
                    input.addEventListener('change', () => {
                        applyFilters();
                    });
                    input.addEventListener('input', () => {
                        applyFilters();
                    });
                }
            });

            // Clear filters button
            if (clearBtn) {
                clearBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    clearFilters();
                });
            }
        });

        // Store responses globally for filtering
        function setResponsesToFilter(responses) {
            allResponses = responses || [];
            renderFilteredTable(allResponses);
        }

        window.setResponsesToFilter = setResponsesToFilter;
    </script>

    <script>
        // Initialize super admin account in Firestore if it doesn't exist
        async function ensureSuperAdminExists() {
            try {
                // Wait for auth to be initialized
                if (!auth.currentUser && SUPER_ADMIN_EMAIL) {
                    console.log('No current user, skipping super admin setup');
                    return;
                }

                // Check if any super_admin exists in the system
                const adminUsersRef = collection(db, 'admin_users');
                const superAdminQuery = query(adminUsersRef, where('role', '==', 'super_admin'));
                const superAdminSnapshot = await getDocs(superAdminQuery);
                
                if (!superAdminSnapshot.empty) {
                    console.log('Super admin account already exists');
                    return;
                }

                // No super admin exists, try to create one
                // First, try to get or create the Firebase Auth account
                try {
                    // Try to sign in with super admin credentials
                    const result = await signInWithEmailAndPassword(auth, SUPER_ADMIN_EMAIL, SUPER_ADMIN_PASSWORD);
                    const superAdminUID = result.user.uid;

                    // Now create the admin_users document for this account
                    const superAdminDocRef = doc(db, 'admin_users', superAdminUID);
                    const superAdminDocSnap = await getDoc(superAdminDocRef);

                    if (!superAdminDocSnap.exists()) {
                        // Create the super admin document
                        await setDoc(superAdminDocRef, {
                            email: SUPER_ADMIN_EMAIL,
                            first_name: 'Super',
                            last_name: 'Administrator',
                            role: 'super_admin',
                            status: 'active',
                            created_at: serverTimestamp(),
                            created_by: 'system',
                            activated_at: serverTimestamp(),
                            activated_by: 'system'
                        });
                        console.log('Super admin account created in Firestore');
                    } else {
                        // Document exists but might not have super_admin role, ensure it does
                        const data = superAdminDocSnap.data();
                        if (data.role !== 'super_admin') {
                            await setDoc(superAdminDocRef, {
                                ...data,
                                role: 'super_admin',
                                status: 'active'
                            }, { merge: true });
                            console.log('Super admin role ensured');
                        }
                    }

                    // Sign out immediately after setup (user will sign in normally)
                    await auth.signOut();
                    console.log('Super admin setup complete');
                } catch (authError) {
                    if (authError.code === 'auth/user-not-found') {
                        // Account doesn't exist, can't create (would need Cloud Function or admin SDK)
                        console.warn('Super admin account does not exist. Please create it manually.');
                    } else if (authError.code === 'auth/wrong-password') {
                        console.warn('Super admin password incorrect. Please check the SUPER_ADMIN_PASSWORD in code.');
                    } else {
                        console.warn('Could not setup super admin:', authError.message);
                    }
                }
            } catch (error) {
                console.warn('ensureSuperAdminExists error:', error);
            }
        }

        // Call setup on page load
        try {
            ensureSuperAdminExists().catch(e => console.warn('Super admin setup failed:', e));
        } catch (e) {
            console.warn('Could not call ensureSuperAdminExists:', e);
        }
        const loginView = document.getElementById('loginView');
        const dashboardView = document.getElementById('dashboardView');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const navLinks = document.querySelectorAll('.nav-link');
        const pageContents = document.querySelectorAll('.page-content');
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');

        const showAddUserBtn = document.getElementById('showAddUserBtn'); // NEW
        const addUserForm = document.getElementById('addUserForm'); // NEW
        const goBackBtn = document.getElementById('goBackBtn'); // NEW

        // Loading overlay for login (reusable spinner)
        let loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loadingOverlay';
        loadingOverlay.className = 'loader-overlay';
        loadingOverlay.innerHTML = '<div class="loader-wrap"><div class="loader-spinner" aria-hidden="true"></div><div class="loader-text" id="loaderText">Loadingâ€¦</div></div>';

        function showLoader(text = 'Loadingâ€¦') {
            try {
                const txt = loadingOverlay.querySelector('#loaderText');
                if (txt) txt.textContent = text;
            } catch (e) { /* ignore */ }
            if (!document.body.contains(loadingOverlay)) document.body.appendChild(loadingOverlay);
            loadingOverlay.style.display = 'flex';
        }
        function hideLoader() {
            try {
                loadingOverlay.style.display = 'none';
                if (document.body.contains(loadingOverlay)) document.body.removeChild(loadingOverlay);
            } catch (e) { /* ignore */ }
        }

        // User dropdown behavior
        document.addEventListener('click', function(e) {
            const userDropdown = document.getElementById('userDropdown');
            if (!userDropdown) return;
            // If click is outside the user menu, hide the dropdown
            const userMenu = document.getElementById('userMenu');
            if (userMenu && !userMenu.contains(e.target)) {
                userDropdown.classList.add('hidden');
            }
        });

        // ===== TOAST NOTIFICATION SYSTEM =====
        function showToast(message, type = 'info', duration = 3000) {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'fixed top-4 right-4 z-[9999] space-y-2 pointer-events-none';
                document.body.appendChild(toastContainer);
            }

            // Create toast element
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg pointer-events-auto flex items-center gap-2 animate-fade-in-down`;
            
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ“' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            
            toastContainer.appendChild(toast);

            // Auto remove after duration
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.style.transition = 'opacity 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ===== ROLE-BASED ACCESS CONTROL =====
        const rolePermissions = {
            'super_admin': ['dashboard', 'raw-responses', 'compliance-reports', 'manage-questions', 'user-management'],
            'admin': ['dashboard', 'raw-responses', 'compliance-reports', 'manage-questions', 'user-management'],
            'data_analyst': ['dashboard', 'raw-responses', 'compliance-reports'],
            'survey_manager': ['dashboard', 'manage-questions']
        };

        function updateNavbarAccessControl(userRole) {
            const allowedTabs = rolePermissions[userRole] || [];
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                const view = link.getAttribute('data-view');
                
                if (allowedTabs.includes(view)) {
                    // Enable tab
                    link.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
                    link.style.cursor = 'pointer';
                } else {
                    // Disable tab
                    link.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
                    link.style.cursor = 'not-allowed';
                    link.style.pointerEvents = 'none';
                }
            });
        }

        // Modal helper functions
        function showModal(modalId) { const m = document.getElementById(modalId); if (m) m.classList.remove('hidden-modal'); }
        function hideModal(modalId) { const m = document.getElementById(modalId); if (m) m.classList.add('hidden-modal'); }

        // Add CSS for toast animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeInDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .animate-fade-in-down {
                animation: fadeInDown 0.3s ease-out;
            }
        `;
        document.head.appendChild(style);

        document.addEventListener('DOMContentLoaded', function() {
            // Update user menu button if user is already logged in
            try {
                const adminUserJson = sessionStorage.getItem('adminUser');
                if (adminUserJson) {
                    const adminUser = JSON.parse(adminUserJson);
                    const userMenuButton = document.getElementById('userMenuButton');
                    if (userMenuButton && adminUser.role) {
                        const roleText = adminUser.role.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                        const buttonSpan = userMenuButton.querySelector('span');
                        if (buttonSpan) {
                            buttonSpan.textContent = roleText;
                        }
                    }
                    
                    // Update navbar access control based on role
                    if (adminUser.role) {
                        updateNavbarAccessControl(adminUser.role);
                    }
                }
            } catch (e) {
                console.warn('Could not update user menu button from sessionStorage:', e);
            }

            // Forgot password modal
            const forgotPasswordLink = document.getElementById('forgotPasswordLink');
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    showModal('forgotPasswordModal');
                });
            }
            const closeForgotPasswordModal = document.getElementById('closeForgotPasswordModal');
            if (closeForgotPasswordModal) {
                closeForgotPasswordModal.addEventListener('click', function() { hideModal('forgotPasswordModal'); });
            }
            const forgotPasswordBackdrop = document.getElementById('forgotPasswordBackdrop');
            if (forgotPasswordBackdrop) {
                forgotPasswordBackdrop.addEventListener('click', function() { hideModal('forgotPasswordModal'); });
            }

            // User menu and logout
            const userMenuButton = document.getElementById('userMenuButton');
            const userDropdown = document.getElementById('userDropdown');
            if (userMenuButton && userDropdown) {
                userMenuButton.addEventListener('click', function(ev) {
                    ev.stopPropagation();
                    userDropdown.classList.toggle('hidden');
                });
            }
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showModal('logoutConfirmModal');
                });
            }

            // Logout confirmation modal
            const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
            if (cancelLogoutBtn) {
                cancelLogoutBtn.addEventListener('click', function() { hideModal('logoutConfirmModal'); });
            }
            const logoutConfirmBackdrop = document.getElementById('logoutConfirmBackdrop');
            if (logoutConfirmBackdrop) {
                logoutConfirmBackdrop.addEventListener('click', function() { hideModal('logoutConfirmModal'); });
            }
            const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
            if (confirmLogoutBtn) {
                confirmLogoutBtn.addEventListener('click', function() {
                    // Perform actual logout
                    function _finalize() { try { localStorage.clear(); } catch (e) {} window.location.reload(); }
                    try {
                        if (window.auth && typeof window.signOut === 'function') {
                            window.signOut(window.auth).then(_finalize).catch(_finalize);
                            return;
                        }
                    } catch(e){}
                    try {
                        if (window.firebase && window.firebase.auth) {
                            window.firebase.auth().signOut().then(_finalize).catch(_finalize);
                            return;
                        }
                    } catch(e){}
                    _finalize();
                });
            }
        });

        let currentView = 'dashboard';

        // --- Core Functions ---

        /**
         * Initializes Chart.js graphs for the dashboard.
         * Must be called only once or after the dashboard view is visible.
         */
        function initCharts() {
            // Check if charts are already initialized
            if (window.serviceChartInstance || window.clientTypeChartInstance) return;
            
            // Chart 1: Average Rating per Service (Horizontal Bar) - Start empty
            const serviceCtx = document.getElementById('serviceChart');
            if (serviceCtx) {
                window.serviceChartInstance = new Chart(serviceCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Average SQD Score',
                            data: [],
                            backgroundColor: '#2563EB',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 5,
                                grid: { drawBorder: false },
                                ticks: { stepSize: 1 }
                            },
                            y: {
                                grid: { drawBorder: false, display: false }
                            }
                        }
                    }
                });
            }

            // Chart 2: Client Type Distribution (Doughnut) - Start empty
            const clientTypeCtx = document.getElementById('clientTypeChart');
            if (clientTypeCtx) {
                window.clientTypeChartInstance = new Chart(clientTypeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Citizen', 'Business', 'Government'],
                        datasets: [{
                            label: 'Client Type Distribution',
                            data: [0, 0, 0],
                            backgroundColor: ['#1D4ED8', '#60A5FA', '#93C5FD']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const value = context.parsed || 0;
                                        const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${pct}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        /**
         * Handles screen navigation within the dashboard.
         * @param {string} viewId - The ID of the view to show (e.g., 'dashboard', 'raw-responses').
         */
        function navigateTo(viewId) {
            currentView = viewId;
            
            // 1. Hide all page contents
            pageContents.forEach(content => {
                content.classList.add('hidden');
            });

            // 2. Show the requested page content
            const targetContent = document.getElementById(viewId);
            if (targetContent) {
                targetContent.classList.remove('hidden');
                
                // Special case: Initialize charts on dashboard load
                if (viewId === 'dashboard') {
                    initCharts();
                }

                // Special case: Load questions on manage-questions load
                if (viewId === 'manage-questions') {
                    // Ensure defaults exist, then render questions (ensures automatic population)
                    ensureDefaultQuestionsExist().then(() => {
                        loadSurveyQuestions();
                    }).catch((e) => {
                        console.warn('ensureDefaultQuestionsExist failed:', e);
                        loadSurveyQuestions();
                    });
                }

                // Special case: Load admin users on user-management load
                if (viewId === 'user-management') {
                    try { loadAdminUsers(); } catch (e) { console.warn('Could not start admin_users listener on navigation', e); }
                }
            }

            // 3. Update active sidebar link state
            // Logic to handle 'add-user-form' being a sub-view of 'user-management'
            let activeLinkView = viewId === 'add-user-form' ? 'user-management' : viewId;

            navLinks.forEach(link => {
                link.classList.remove('bg-white', 'text-[#0b296b]', 'shadow-lg');
                link.classList.add('hover:bg-[#1f3f80]', 'text-gray-200');
                if (link.dataset.view === activeLinkView) {
                    link.classList.add('bg-white', 'text-[#0b296b]', 'shadow-lg');
                    link.classList.remove('hover:bg-[#1f3f80]', 'text-gray-200');
                }
            });

            // 4. Hide sidebar on mobile after navigation
            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
            }
        }
        
        /**
         * Toggles the main application view between Login and Dashboard.
         * @param {boolean} loggedIn - True to show dashboard, false to show login.
         */
        function toggleAppView(loggedIn) {
            if (loggedIn) {
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                navigateTo('dashboard'); // Default to dashboard home
                // Ensure charts are initialized and updated after login
                setTimeout(() => {
                    if (typeof window.updateMetrics === 'function' && window.allSurveyResponses) {
                        window.updateMetrics(window.allSurveyResponses);
                    }
                    if (typeof window.updateCharts === 'function' && window.allSurveyResponses) {
                        window.updateCharts(window.allSurveyResponses);
                    }
                }, 200);
            } else {
                dashboardView.classList.add('hidden');
                loginView.classList.remove('hidden');
                loginError.classList.add('hidden');
            }
            // Re-render Lucide icons after DOM manipulation
            lucide.createIcons(); 
        }

        /**
         * Clears all validation error messages for the Add User form.
         */
        function clearAddUserErrors() {
            document.getElementById('firstNameError').classList.add('hidden');
            document.getElementById('lastNameError').classList.add('hidden');
            document.getElementById('emailError').classList.add('hidden');
            document.getElementById('roleError').classList.add('hidden');
        }

        /**
         * Validates the Add User form fields.
         * @returns {boolean} True if the form is valid, false otherwise.
         */
        function validateAddUserForm() {
            clearAddUserErrors();
            let isValid = true;

            const firstName = document.getElementById('firstName');
            const lastName = document.getElementById('lastName');
            const userEmail = document.getElementById('userEmail');
            const userRole = document.getElementById('userRole');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (firstName.value.trim() === '') {
                document.getElementById('firstNameError').classList.remove('hidden');
                isValid = false;
            }

            if (lastName.value.trim() === '') {
                document.getElementById('lastNameError').classList.remove('hidden');
                isValid = false;
            }

            if (!emailRegex.test(userEmail.value) || userEmail.value.trim() === '') {
                document.getElementById('emailError').classList.remove('hidden');
                isValid = false;
            }

            if (userRole.value === '' || userRole.value === 'Select a role') { // Check for default disabled option
                document.getElementById('roleError').classList.remove('hidden');
                isValid = false;
            }

            return isValid;
        }

        /**
         * Store survey questions globally - loaded from survey.html's script.js
         */
        window.allSurveyQuestions = [];

        /**
         * Load survey questions from the global sqdQuestions array (from script.js)
         * This syncs with what users see in survey.html
         */
        /**
         * Initialize survey questions from Firestore with real-time listener
         */
        function initializeSurveyQuestionsFromFirestore() {
            try {
                if (!window.db || !window.collection || !window.onSnapshot) {
                    console.warn('Firestore modular APIs not yet available for initializeSurveyQuestionsFromFirestore');
                    return;
                }

                const questionsRef = window.collection(window.db, 'survey_questions');

                // Real-time listener for questions (use modular onSnapshot)
                window.onSnapshot(questionsRef, (snapshot) => {
                    window.allSurveyQuestions = [];
                    snapshot.forEach((docSnap) => {
                        const data = typeof docSnap.data === 'function' ? docSnap.data() : (docSnap.data || {});
                        window.allSurveyQuestions.push({
                            id: docSnap.id,
                            code: data.code || '',
                            text: data.text || '',
                            type: data.type || 'SQD',
                            required: typeof data.required === 'boolean' ? data.required : true,
                            order: typeof data.order === 'number' ? data.order : 0
                        });
                    });

                    // Ensure deterministic ordering
                    window.allSurveyQuestions.sort((a, b) => (a.order || 0) - (b.order || 0));

                    console.log('Questions synced from Firestore:', window.allSurveyQuestions.length);

                    // Refresh UI if manage-questions tab is active
                    if (document.getElementById('manage-questions') && !document.getElementById('manage-questions').classList.contains('hidden')) {
                        loadSurveyQuestions();
                    }
                }, (error) => {
                    console.error('Error loading questions:', error);
                });
            } catch (err) {
                console.error('initializeSurveyQuestionsFromFirestore error:', err);
            }
        }

        /**
         * Modular-safe initializer: add default questions using modular Firestore API
         * This works with the `db`, `doc`, `getDoc`, `setDoc`, `collection`, and `getDocs` imports
         */
        async function initializeDefaultSurveyQuestionsModular() {
            try {
                const questionsCol = window.collection ? window.collection(window.db, 'survey_questions') : null;

                const defaultQuestions = [
                    { code: 'SQD0', text: 'I am satisfied with the service that I availed.', type: 'SQD', required: true, order: 0 },
                    { code: 'SQD1', text: 'I spent a reasonable amount of time for my transaction.', type: 'SQD', required: true, order: 1 },
                    { code: 'SQD2', text: 'The office followed the transaction\'s requirements and steps based on the information provided.', type: 'SQD', required: true, order: 2 },
                    { code: 'SQD3', text: 'The steps (including payment) I needed to do for my transaction were easy and simple.', type: 'SQD', required: true, order: 3 },
                    { code: 'SQD4', text: 'I easily found information about my transaction from the office or its website.', type: 'SQD', required: true, order: 4 },
                    { code: 'SQD5', text: 'I paid a reasonable amount of fees for my transaction. (If service was free, mark the \'N/A\' option)', type: 'SQD', required: true, order: 5 },
                    { code: 'SQD6', text: 'I feel the office was fair to everyone, or \'walang palakasan\', during my transaction.', type: 'SQD', required: true, order: 6 },
                    { code: 'SQD7', text: 'I was treated courteously by the staff, and (if asked for help) the staff was helpful.', type: 'SQD', required: true, order: 7 },
                    { code: 'SQD8', text: 'I got what I needed from the government office, or if denied, the reason was explained to me clearly.', type: 'SQD', required: true, order: 8 },
                    { code: 'CC1', text: 'Which of the following best describes your awareness of a CC?', type: 'CC', required: true, order: 9 },
                    { code: 'CC2', text: 'If aware of the CC (answered 1â€“3 in CC1), would you say that the CC of this office was easy to see?', type: 'CC', required: true, order: 10 },
                    { code: 'CC3', text: 'If aware of the CC (answered 1â€“3 in CC1), would you say that the CC of this office was helpful?', type: 'CC', required: true, order: 11 }
                ];

                let added = 0;
                for (const q of defaultQuestions) {
                    const docId = q.code.toLowerCase();
                    const qDocRef = window.doc ? window.doc(window.db, 'survey_questions', docId) : null;
                    const snap = window.getDoc ? await window.getDoc(qDocRef) : null;
                    if (!snap || !snap.exists || !snap.exists()) {
                        if (window.setDoc && qDocRef) {
                            await window.setDoc(qDocRef, {
                                code: q.code,
                                text: q.text,
                                type: q.type,
                                required: q.required,
                                order: q.order,
                                createdAt: window.serverTimestamp ? window.serverTimestamp() : null
                            });
                        } else if (window.db && window.firebase && window.firebase.firestore) {
                            // Fallback to namespaced SDK if available
                            const nsDb = window.firebase.firestore();
                            await nsDb.collection('survey_questions').doc(docId).set({
                                code: q.code,
                                text: q.text,
                                type: q.type,
                                required: q.required,
                                order: q.order,
                                createdAt: new Date()
                            });
                        }
                        added++;
                    }
                }

                console.log(`Default questions initializer finished. Added: ${added}`);
                if (added > 0) {
                    alert(`Default questions added: ${added}`);
                } else {
                    alert('Default questions already present. No changes made.');
                }
            } catch (error) {
                console.error('Error initializing default questions (modular):', error);
                alert('Error initializing default questions: ' + (error.message || error));
            }
        }

        /**
         * Check collection and add defaults if empty
         */
        async function ensureDefaultQuestionsExist() {
            try {
                const qSnapshot = window.getDocs && window.collection ? await window.getDocs(window.collection(window.db, 'survey_questions')) : null;
                if (!qSnapshot || qSnapshot.size === 0) {
                    console.log('No survey_questions found â€” initializing defaults...');
                    await initializeDefaultSurveyQuestionsModular();
                } else {
                    console.log('survey_questions collection already populated:', qSnapshot.size);
                }
            } catch (err) {
                console.error('Error checking survey_questions collection:', err);
            }
        }

        /**
         * Initialize default questions to Firestore (first time setup)
         */
        async function loadDefaultQuestionsToFirestore() {
            const db = firebase.firestore();
            const questionsRef = db.collection('survey_questions');

            try {
                // Check if questions already exist
                const existingQuestions = await questionsRef.limit(1).get();
                if (!existingQuestions.empty) {
                    console.log('Questions already exist in Firestore');
                    return;
                }

                // Default questions
                const defaultQuestions = [
                    { code: 'SQD0', text: 'I am satisfied with the service that I availed.', type: 'SQD', required: true, order: 0 },
                    { code: 'SQD1', text: 'I spent a reasonable amount of time for my transaction.', type: 'SQD', required: true, order: 1 },
                    { code: 'SQD2', text: 'The office followed the transaction\'s requirements and steps based on the information provided.', type: 'SQD', required: true, order: 2 },
                    { code: 'SQD3', text: 'The steps (including payment) I needed to do for my transaction were easy and simple.', type: 'SQD', required: true, order: 3 },
                    { code: 'SQD4', text: 'I easily found information about my transaction from the office or its website.', type: 'SQD', required: true, order: 4 },
                    { code: 'SQD5', text: 'I paid a reasonable amount of fees for my transaction. (If service was free, mark the \'N/A\' option)', type: 'SQD', required: true, order: 5 },
                    { code: 'SQD6', text: 'I feel the office was fair to everyone, or \'walang palakasan\', during my transaction.', type: 'SQD', required: true, order: 6 },
                    { code: 'SQD7', text: 'I was treated courteously by the staff, and (if asked for help) the staff was helpful.', type: 'SQD', required: true, order: 7 },
                    { code: 'SQD8', text: 'I got what I needed from the government office, or if denied, the reason was explained to me clearly.', type: 'SQD', required: true, order: 8 },
                    { code: 'CC1', text: 'Which of the following best describes your awareness of a CC?', type: 'CC', required: true, order: 9 },
                    { code: 'CC2', text: 'If aware of the CC (answered 1â€“3 in CC1), would you say that the CC of this office was easy to see?', type: 'CC', required: true, order: 10 },
                    { code: 'CC3', text: 'If aware of the CC (answered 1â€“3 in CC1), would you say that the CC of this office was helpful?', type: 'CC', required: true, order: 11 }
                ];

                // Add all questions to Firestore
                for (const question of defaultQuestions) {
                    const docId = question.code.toLowerCase();
                    await questionsRef.doc(docId).set(question);
                }

                console.log('Default questions loaded to Firestore');
            } catch (error) {
                console.error('Error loading default questions:', error);
            }
        }

        /**
         * Load survey questions from Firestore or use defaults
         */
        function loadSurveyQuestions() {
            const questionsContainer = document.getElementById('questionsContainer');
            if (!questionsContainer) return;

            questionsContainer.innerHTML = '';

            const questions = window.allSurveyQuestions || [];

            if (questions.length === 0) {
                questionsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No questions available</p>';
                return;
            }

            questions.forEach((question, index) => {
                const typeColor = question.type === 'SQD' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                const typeLabel = question.type === 'SQD' ? 'SQD METRIC' : 'CC METRIC';
                
                const questionCard = document.createElement('div');
                questionCard.className = 'bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-600 flex justify-between items-start';
                questionCard.innerHTML = `
                    <div class="flex-1">
                        <p class="font-semibold text-lg text-gray-800">${question.code}: ${question.text}</p>
                        <div class="mt-2 space-x-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeColor}">${typeLabel}</span>
                            ${question.required ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">REQUIRED</span>' : ''}
                            <button class="edit-btn text-xs font-medium text-blue-600 hover:text-blue-800 p-1 rounded-md transition duration-150" data-question-id="${question.id}">EDIT</button>
                        </div>
                    </div>
                    <button class="delete-btn text-gray-400 hover:text-red-500 transition duration-150" data-question-id="${question.id}">
                        <i data-lucide="trash-2" class="w-6 h-6"></i>
                    </button>
                `;
                questionsContainer.appendChild(questionCard);
            });

            // Re-render Lucide icons
            if (window.lucide) {
                lucide.createIcons();
            }

            // Attach event listeners to edit and delete buttons
            attachQuestionEventListeners();
        }

        /**
         * Attach event listeners to edit and delete buttons
         */
        function attachQuestionEventListeners() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-question-id');
                    openEditQuestionModal(questionId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const questionId = this.getAttribute('data-question-id');
                    const question = window.allSurveyQuestions.find(q => q.id === questionId);
                    showConfirmationModal(
                        'Delete Question',
                        `Are you sure you want to delete "${question.code}: ${question.text}"?`,
                        () => deleteQuestion(questionId)
                    );
                });
            });
        }

        /**
         * Open edit question modal
         */
        function openEditQuestionModal(questionId) {
            const question = window.allSurveyQuestions.find(q => q.id === questionId);
            if (!question) return;

            document.getElementById('editQuestionCode').value = question.code;
            document.getElementById('editQuestionText').value = question.text;
            document.getElementById('editQuestionType').value = question.type;
            document.getElementById('editQuestionRequired').checked = question.required;

            const modal = document.getElementById('editQuestionModal');
            modal.classList.remove('hidden');

            // Store the question ID for use in save function
            modal.dataset.questionId = questionId;
        }

        /**
         * Close edit question modal
         */
        function closeEditQuestionModal() {
            document.getElementById('editQuestionModal').classList.add('hidden');
        }

        /**
         * Open add question modal
         */
        function openAddQuestionModal() {
            document.getElementById('addQuestionForm').reset();
            document.getElementById('addQuestionModal').classList.remove('hidden');
        }

        /**
         * Close add question modal
         */
        function closeAddQuestionModal() {
            document.getElementById('addQuestionModal').classList.add('hidden');
        }

        /**
         * Save edited question to Firestore
         */
        function saveEditedQuestion(event) {
            event.preventDefault();
            const modal = document.getElementById('editQuestionModal');
            const questionId = modal.dataset.questionId;
            
            const question = window.allSurveyQuestions.find(q => q.id === questionId);
            if (!question) return;

            const updatedText = document.getElementById('editQuestionText').value;
            const updatedType = document.getElementById('editQuestionType').value;
            const updatedRequired = document.getElementById('editQuestionRequired').checked;

            (async () => {
                try {
                    if (window.setDoc && window.doc) {
                        const qRef = window.doc(window.db, 'survey_questions', questionId);
                        await window.setDoc(qRef, {
                            text: updatedText,
                            type: updatedType,
                            required: updatedRequired,
                            updatedAt: window.serverTimestamp ? window.serverTimestamp() : null
                        }, { merge: true });
                        closeEditQuestionModal();
                        alert('Question updated successfully!');
                        return;
                    }

                    // Fallback to namespaced SDK
                    if (window.firebase && window.firebase.firestore) {
                        const nsDb = window.firebase.firestore();
                        await nsDb.collection('survey_questions').doc(questionId).update({
                            text: updatedText,
                            type: updatedType,
                            required: updatedRequired
                        });
                        closeEditQuestionModal();
                        alert('Question updated successfully!');
                        return;
                    }

                    throw new Error('No Firestore API available to update question');
                } catch (error) {
                    console.error('Error updating question:', error);
                    alert('Error updating question: ' + (error.message || error));
                }
            })();
        }

        /**
         * Add new question to Firestore
         */
        function addNewQuestion(event) {
            event.preventDefault();
            
            const code = document.getElementById('newQuestionCode').value.trim();
            const text = document.getElementById('newQuestionText').value.trim();
            const type = document.getElementById('newQuestionType').value;
            const required = document.getElementById('newQuestionRequired').checked;

            // Validate inputs
            if (!code || !text) {
                alert('Code and text are required!');
                return;
            }

            // Check if question code already exists
            if (window.allSurveyQuestions.some(q => q.code === code)) {
                alert('A question with this code already exists!');
                return;
            }


            const docId = code.toLowerCase();
            const maxOrder = window.allSurveyQuestions.length > 0 
                ? Math.max(...window.allSurveyQuestions.map(q => q.order || 0)) + 1
                : window.allSurveyQuestions.length;

            (async () => {
                try {
                    if (window.setDoc && window.doc) {
                        const qRef = window.doc(window.db, 'survey_questions', docId);
                        await window.setDoc(qRef, {
                            code: code,
                            text: text,
                            type: type,
                            required: required,
                            order: maxOrder,
                            createdAt: window.serverTimestamp ? window.serverTimestamp() : null
                        });
                        closeAddQuestionModal();
                        alert('Question added successfully!');
                        return;
                    }

                    // Fallback to namespaced SDK
                    if (window.firebase && window.firebase.firestore) {
                        const nsDb = window.firebase.firestore();
                        await nsDb.collection('survey_questions').doc(docId).set({
                            code: code,
                            text: text,
                            type: type,
                            required: required,
                            order: maxOrder,
                            createdAt: new Date()
                        });
                        closeAddQuestionModal();
                        alert('Question added successfully!');
                        return;
                    }

                    throw new Error('No Firestore API available to add question');
                } catch (error) {
                    console.error('Error adding question:', error);
                    alert('Error adding question: ' + (error.message || error));
                }
            })();
        }

        /**
         * Delete question from Firestore
         */
        function deleteQuestion(questionId) {
            (async () => {
                try {
                    if (window.deleteDoc && window.doc) {
                        const qRef = window.doc(window.db, 'survey_questions', questionId);
                        await window.deleteDoc(qRef);
                        alert('Question deleted successfully!');
                        return;
                    }

                    if (window.firebase && window.firebase.firestore) {
                        const nsDb = window.firebase.firestore();
                        await nsDb.collection('survey_questions').doc(questionId).delete();
                        alert('Question deleted successfully!');
                        return;
                    }

                    throw new Error('No Firestore API available to delete question');
                } catch (error) {
                    console.error('Error deleting question:', error);
                    alert('Error deleting question: ' + (error.message || error));
                }
            })();
        }

        /**
         * Show confirmation modal
         * @param {string} title - Modal title
         * @param {string} message - Modal message
         * @param {function} onConfirm - Callback when user confirms

         */
        function showConfirmationModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Remove old event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            // Add new event listeners
            newConfirmBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
                onConfirm();
            });
            
            newCancelBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            
            modal.classList.remove('hidden');
        }

        /**
         * Export survey responses to CSV format using Firestore data
         */
        function exportToCSV() {
            const responses = window.allSurveyResponses || [];
            
            if (responses.length === 0) {
                alert('No survey data available to export.');
                return;
            }

            // Build CSV header
            let csvContent = 'Timestamp,Office Location,Client Type,Service Availed,SQD Score\n';

            // Add data rows from Firestore
            responses.forEach(response => {
                const sq = response.serviceQuality || {};
                let sqSum = 0, sqCount = 0;
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) { sqSum += v; sqCount += 1; }
                });
                const avgSqd = sqCount > 0 ? (sqSum / sqCount).toFixed(2) : 'N/A';

                const submittedAt = response.submittedAt ? new Date(response.submittedAt.toDate ? response.submittedAt.toDate() : response.submittedAt).toLocaleString() : 'N/A';
                const officeLocation = response.regionOfResidence || 'N/A';
                const clientType = response.clientType || 'Unknown';
                const serviceAvailed = response.serviceAvailed || 'N/A';

                const row = [
                    `"${submittedAt}"`,
                    `"${officeLocation}"`,
                    `"${clientType}"`,
                    `"${serviceAvailed}"`,
                    avgSqd
                ];
                csvContent += row.join(',') + '\n';
            });

            // Create and download CSV
            const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `survey-responses-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Export ARTA Compliance Report as PDF using Firestore data with charts and graphs
         */
        async function exportToPDF() {
            const responses = window.allSurveyResponses || [];
            
            if (responses.length === 0) {
                alert('No survey data available to generate report.');
                return;
            }

            // Show loading indicator
            const btn = document.getElementById('downloadPdfBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating PDF...';
            btn.disabled = true;

            // Calculate comprehensive metrics from Firestore data
            let totalSqdSum = 0, totalSqdCount = 0;
            const serviceMap = {};
            const regionMap = {};
            const clientTypeCounts = { Citizen: 0, Business: 0, Government: 0, OFW: 0 };
            const ccAwareCount = { Yes: 0, No: 0 };
            const satisfactionRanges = { 'Very Satisfied (4.5-5)': 0, 'Satisfied (3.5-4.4)': 0, 'Neutral (2.5-3.4)': 0, 'Dissatisfied (<2.5)': 0 };

            responses.forEach(doc => {
                // Aggregate service SQD scores
                const sq = doc.serviceQuality || {};
                let sqSum = 0, sqCount = 0;
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) {
                        sqSum += v;
                        sqCount += 1;
                        totalSqdSum += v;
                        totalSqdCount += 1;
                    }
                });
                const avgScore = sqCount > 0 ? (sqSum / sqCount) : 0;

                // Categorize satisfaction
                if (avgScore >= 4.5) satisfactionRanges['Very Satisfied (4.5-5)'] += 1;
                else if (avgScore >= 3.5) satisfactionRanges['Satisfied (3.5-4.4)'] += 1;
                else if (avgScore >= 2.5) satisfactionRanges['Neutral (2.5-3.4)'] += 1;
                else satisfactionRanges['Dissatisfied (<2.5)'] += 1;

                // Aggregate services
                const svc = (doc.serviceAvailed || 'Unknown').trim() || 'Unknown';
                if (!serviceMap[svc]) serviceMap[svc] = { count: 0, totalScore: 0, scoreCount: 0 };
                serviceMap[svc].count += 1;
                serviceMap[svc].totalScore += sqSum;
                serviceMap[svc].scoreCount += sqCount;

                // Aggregate regions
                const region = (doc.regionOfResidence || 'Not Specified').trim();
                if (!regionMap[region]) regionMap[region] = 0;
                regionMap[region] += 1;

                // Aggregate client types
                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                if (ctRaw.includes('citizen')) clientTypeCounts.Citizen += 1;
                else if (ctRaw.includes('business')) clientTypeCounts.Business += 1;
                else if (ctRaw.includes('government')) clientTypeCounts.Government += 1;
                else if (ctRaw.includes('ofw')) clientTypeCounts.OFW += 1;

                // Aggregate Citizen Charter awareness
                if (doc.citizensCharter && doc.citizensCharter.cc1 !== '4') ccAwareCount.Yes += 1;
                else ccAwareCount.No += 1;
            });

            const totalResponses = responses.length;
            const avgSqd = totalSqdCount > 0 ? (totalSqdSum / totalSqdCount).toFixed(2) : 0;
            
            let mostAvailed = 'No data';
            let maxCount = 0;
            Object.keys(serviceMap).forEach(svc => {
                if (serviceMap[svc].count > maxCount) {
                    maxCount = serviceMap[svc].count;
                    mostAvailed = svc;
                }
            });

            const total = totalResponses;
            const pct = (n) => ((n / total) * 100).toFixed(1);
            const citizenPct = pct(clientTypeCounts.Citizen);
            const businessPct = pct(clientTypeCounts.Business);
            const governmentPct = pct(clientTypeCounts.Government);
            const ofwPct = pct(clientTypeCounts.OFW);
            const ccAwarePct = pct(ccAwareCount.Yes);

            // Generate chart images with proper sizing
            let serviceChartImage = '';
            let clientTypeChartImage = '';

            // Helper function to resize chart images
            function resizeChartImage(base64Img, maxWidth = 500, maxHeight = 280) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * maxWidth / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * maxHeight / height);
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.85));
                    };
                    img.src = base64Img;
                });
            }

            // Capture and resize service chart
            if (window.serviceChartInstance) {
                try {
                    const fullImage = window.serviceChartInstance.toBase64Image();
                    serviceChartImage = await resizeChartImage(fullImage, 500, 280);
                } catch(e) {
                    console.log('Could not capture service chart');
                }
            }

            // Capture and resize client type chart
            if (window.clientTypeChartInstance) {
                try {
                    const fullImage = window.clientTypeChartInstance.toBase64Image();
                    clientTypeChartImage = await resizeChartImage(fullImage, 450, 250);
                } catch(e) {
                    console.log('Could not capture client type chart');
                }
            }

            // Build detailed HTML content for PDF
            let serviceTableHtml = '<table style="width: 100%; border-collapse: collapse; font-size: 11px; margin: 10px 0;"><tr style="background: #e3f2fd;"><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Service</th><th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Count</th><th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Avg Score</th></tr>';
            Object.keys(serviceMap).forEach(svc => {
                const count = serviceMap[svc].count;
                const avgScore = serviceMap[svc].scoreCount > 0 ? (serviceMap[svc].totalScore / serviceMap[svc].scoreCount).toFixed(2) : 0;
                serviceTableHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${svc}</td><td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${count}</td><td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${avgScore}</td></tr>`;
            });
            serviceTableHtml += '</table>';

            let regionTableHtml = '<table style="width: 100%; border-collapse: collapse; font-size: 11px; margin: 10px 0;"><tr style="background: #e3f2fd;"><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Region</th><th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Count</th><th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Percentage</th></tr>';
            Object.keys(regionMap).sort().forEach(region => {
                const count = regionMap[region];
                const percentage = pct(count);
                regionTableHtml += `<tr><td style="border: 1px solid #ddd; padding: 8px;">${region}</td><td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${count}</td><td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${percentage}%</td></tr>`;
            });
            regionTableHtml += '</table>';

            const htmlContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <!-- Title Section -->
                    <div style="text-align: center; margin-bottom: 20px; border-bottom: 3px solid #0b296b; padding-bottom: 15px;">
                        <h1 style="margin: 0; color: #0b296b; font-size: 28px;">ARTA Customer Satisfaction Survey</h1>
                        <h2 style="margin: 5px 0 0 0; color: #2563eb; font-size: 20px;">Compliance Report</h2>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">Generated: ${new Date().toLocaleString()}</p>
                    </div>
                    
                    <!-- Compliance Notice -->
                    <div style="background: #e3f2fd; padding: 12px; border-left: 4px solid #2196f3; margin: 20px 0; border-radius: 4px;">
                        <strong style="color: #0b296b;">ARTA COMPLIANCE NOTICE:</strong> This report contains official metrics required for ARTA submission and follows all regulatory requirements.
                    </div>

                    <!-- Key Metrics Summary -->
                    <div style="margin: 25px 0;">
                        <h3 style="color: #0b296b; border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 15px;">EXECUTIVE SUMMARY</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="background: #f3f4f6; padding: 12px; border-left: 4px solid #2563eb; border-radius: 4px;">
                                <p style="margin: 0; font-size: 12px; color: #666;">Total Survey Responses</p>
                                <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #0b296b;">${totalResponses}</p>
                            </div>
                            <div style="background: #f3f4f6; padding: 12px; border-left: 4px solid #059669; border-radius: 4px;">
                                <p style="margin: 0; font-size: 12px; color: #666;">Average Satisfaction Score</p>
                                <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #0b296b;">${avgSqd} <span style="font-size: 14px;">/ 5.0</span></p>
                            </div>
                            <div style="background: #f3f4f6; padding: 12px; border-left: 4px solid #dc2626; border-radius: 4px;">
                                <p style="margin: 0; font-size: 12px; color: #666;">Most Availed Service</p>
                                <p style="margin: 5px 0 0 0; font-size: 14px; font-weight: bold; color: #0b296b;">${mostAvailed}</p>
                            </div>
                            <div style="background: #f3f4f6; padding: 12px; border-left: 4px solid #7c3aed; border-radius: 4px;">
                                <p style="margin: 0; font-size: 12px; color: #666;">Charter Awareness</p>
                                <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #0b296b;">${ccAwarePct}<span style="font-size: 14px;">%</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Client Type Distribution -->
                    <div style="margin: 25px 0; page-break-inside: avoid;">
                        <h3 style="color: #0b296b; border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 15px;">CLIENT TYPE DISTRIBUTION</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 4px; border: 1px solid #e5e7eb;">
                            <p style="margin: 0 0 10px 0; font-weight: bold; color: #374151;">Breakdown:</p>
                            <ul style="margin: 0; padding-left: 20px; list-style: none;">
                                <li style="margin: 8px 0; color: #1f2937;"><span style="font-weight: bold; color: #3b82f6;">Citizen:</span> ${clientTypeCounts.Citizen} (${citizenPct}%)</li>
                                <li style="margin: 8px 0; color: #1f2937;"><span style="font-weight: bold; color: #f59e0b;">Business:</span> ${clientTypeCounts.Business} (${businessPct}%)</li>
                                <li style="margin: 8px 0; color: #1f2937;"><span style="font-weight: bold; color: #ef4444;">Government:</span> ${clientTypeCounts.Government} (${governmentPct}%)</li>
                                <li style="margin: 8px 0; color: #1f2937;"><span style="font-weight: bold; color: #8b5cf6;">OFW:</span> ${clientTypeCounts.OFW} (${ofwPct}%)</li>
                            </ul>
                        </div>
                        ${clientTypeChartImage ? `<div style="margin-top: 15px; text-align: center; page-break-inside: avoid;"><img src="${clientTypeChartImage}" style="width: 100%; max-width: 450px; height: auto; border: 1px solid #e5e7eb; border-radius: 4px;"></div>` : ''}
                    </div>

                    <!-- Satisfaction Levels -->
                    <div style="margin: 25px 0; page-break-inside: avoid;">
                        <h3 style="color: #0b296b; border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 15px;">SATISFACTION LEVELS</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 4px; border: 1px solid #e5e7eb;">
                            <ul style="margin: 0; padding-left: 20px; list-style: none;">
                                <li style="margin: 8px 0; color: #1f2937;"><span style="font-weight: bold; color: #059669;">Very Satisfied (4.5-5.0):</span> ${satisfactionRanges['Very Satisfied (4.5-5)']} responses (${pct(satisfactionRanges['Very Satisfied (4.5-5)'])}%)</li>
                                <li style="margin: 8px 0; color: #1f2937;"><span style="font-weight: bold; color: #3b82f6;">Satisfied (3.5-4.4):</span> ${satisfactionRanges['Satisfied (3.5-4.4)']} responses (${pct(satisfactionRanges['Satisfied (3.5-4.4)'])}%)</li>
                                <li style="margin: 8px 0; color: #1f2937;"><span style="font-weight: bold; color: #f59e0b;">Neutral (2.5-3.4):</span> ${satisfactionRanges['Neutral (2.5-3.4)']} responses (${pct(satisfactionRanges['Neutral (2.5-3.4)'])}%)</li>
                                <li style="margin: 8px 0; color: #1f2937;"><span style="font-weight: bold; color: #ef4444;">Dissatisfied (&lt;2.5):</span> ${satisfactionRanges['Dissatisfied (<2.5)']} responses (${pct(satisfactionRanges['Dissatisfied (<2.5)'])}%)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Services Analysis -->
                    <div style="margin: 25px 0; page-break-inside: avoid;">
                        <h3 style="color: #0b296b; border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 15px;">SERVICES ANALYSIS</h3>
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #666;">Services Availed and Average Satisfaction Scores:</p>
                        ${serviceTableHtml}
                        ${serviceChartImage ? `<div style="margin-top: 15px; text-align: center; page-break-inside: avoid;"><img src="${serviceChartImage}" style="width: 100%; max-width: 500px; height: auto; border: 1px solid #e5e7eb; border-radius: 4px;"></div>` : ''}
                    </div>

                    <!-- Regional Distribution -->
                    <div style="margin: 25px 0; page-break-inside: avoid;">
                        <h3 style="color: #0b296b; border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 15px;">REGIONAL DISTRIBUTION</h3>
                        <p style="margin: 0 0 10px 0; font-size: 12px; color: #666;">Survey Responses by Region:</p>
                        ${regionTableHtml}
                    </div>

                    <!-- Key Findings -->
                    <div style="margin: 25px 0; page-break-inside: avoid;">
                        <h3 style="color: #0b296b; border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 15px;">KEY FINDINGS & INSIGHTS</h3>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 4px; border-left: 4px solid #f59e0b; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #92400e; font-size: 13px;">Overall Performance</h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #1f2937;">
                                <li>Average satisfaction score of <strong>${avgSqd}/5.0</strong> indicates ${avgSqd >= 4.0 ? 'strong' : avgSqd >= 3.0 ? 'moderate' : 'needs improvement in'} service quality</li>
                                <li>${satisfactionRanges['Very Satisfied (4.5-5)'] + satisfactionRanges['Satisfied (3.5-4.4)'] >= total * 0.75 ? '<strong>Positive:</strong> Over 75% of respondents are satisfied or very satisfied' : '<strong>Action Required:</strong> Less than 75% satisfaction rate detected'}</li>
                                <li>Citizens Charter awareness stands at <strong>${ccAwarePct}%</strong> ${ccAwarePct >= 75 ? '(Excellent)' : ccAwarePct >= 50 ? '(Good)' : '(Needs improvement)'}</li>
                                <li>Total respondents: <strong>${totalResponses}</strong> survey submissions across multiple regions</li>
                            </ul>
                        </div>
                        <div style="background: #dbeafe; padding: 15px; border-radius: 4px; border-left: 4px solid #3b82f6; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #1e40af; font-size: 13px;">Service Analysis</h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #1f2937;">
                                <li>Most availed service: <strong>${mostAvailed}</strong></li>
                                <li>Total unique services provided: <strong>${Object.keys(serviceMap).length}</strong></li>
                                <li>Client diversity: Serving citizens, businesses, government agencies, and OFW with balanced distribution</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Performance Metrics Summary -->
                    <div style="margin: 25px 0; page-break-inside: avoid;">
                        <h3 style="color: #0b296b; border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 15px;">DETAILED PERFORMANCE METRICS</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr style="background: #e3f2fd;">
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: left; color: #0b296b; font-weight: bold;">Metric</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: center; color: #0b296b; font-weight: bold;">Value</th>
                                <th style="border: 1px solid #ddd; padding: 10px; text-align: left; color: #0b296b; font-weight: bold;">Status</th>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 10px;">Total Survey Responses</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; font-weight: bold;">${totalResponses}</td>
                                <td style="border: 1px solid #ddd; padding: 10px;"><span style="background: #dcfce7; padding: 3px 8px; border-radius: 3px; color: #166534;">Active</span></td>
                            </tr>
                            <tr style="background: #f9fafb;">
                                <td style="border: 1px solid #ddd; padding: 10px;">Average Satisfaction Score (SQD)</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; font-weight: bold;">${avgSqd} / 5.0</td>
                                <td style="border: 1px solid #ddd; padding: 10px;"><span style="background: ${avgSqd >= 4.0 ? '#dcfce7' : avgSqd >= 3.0 ? '#fef3c7' : '#fee2e2'}; padding: 3px 8px; border-radius: 3px; color: ${avgSqd >= 4.0 ? '#166534' : avgSqd >= 3.0 ? '#92400e' : '#991b1b'};">${avgSqd >= 4.0 ? 'Excellent' : avgSqd >= 3.0 ? 'Good' : 'Needs Improvement'}</span></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 10px;">Citizens Charter Awareness</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; font-weight: bold;">${ccAwarePct}%</td>
                                <td style="border: 1px solid #ddd; padding: 10px;"><span style="background: ${ccAwarePct >= 75 ? '#dcfce7' : ccAwarePct >= 50 ? '#fef3c7' : '#fee2e2'}; padding: 3px 8px; border-radius: 3px; color: ${ccAwarePct >= 75 ? '#166534' : ccAwarePct >= 50 ? '#92400e' : '#991b1b'};">${ccAwarePct >= 75 ? 'Excellent' : ccAwarePct >= 50 ? 'Good' : 'Needs Improvement'}</span></td>
                            </tr>
                            <tr style="background: #f9fafb;">
                                <td style="border: 1px solid #ddd; padding: 10px;">Regions Served</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; font-weight: bold;">${Object.keys(regionMap).length}</td>
                                <td style="border: 1px solid #ddd; padding: 10px;"><span style="background: #dbeafe; padding: 3px 8px; border-radius: 3px; color: #1e40af;">Comprehensive</span></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 10px;">Services Provided</td>
                                <td style="border: 1px solid #ddd; padding: 10px; text-align: center; font-weight: bold;">${Object.keys(serviceMap).length}</td>
                                <td style="border: 1px solid #ddd; padding: 10px;"><span style="background: #dbeafe; padding: 3px 8px; border-radius: 3px; color: #1e40af;">Diverse</span></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Compliance Checklist -->
                    <div style="margin: 25px 0; page-break-inside: avoid;">
                        <h3 style="color: #0b296b; border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 15px;">ARTA COMPLIANCE CHECKLIST</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 4px; border: 1px solid #e5e7eb;">
                            <ul style="margin: 0; padding-left: 20px; list-style: none;">
                                <li style="margin: 8px 0; color: #1f2937;">âœ“ Survey responses collected and documented</li>
                                <li style="margin: 8px 0; color: #1f2937;">âœ“ Service quality data aggregated and analyzed</li>
                                <li style="margin: 8px 0; color: #1f2937;">âœ“ Citizens Charter awareness assessment completed</li>
                                <li style="margin: 8px 0; color: #1f2937;">âœ“ Regional data compiled for all service delivery areas</li>
                                <li style="margin: 8px 0; color: #1f2937;">âœ“ Client satisfaction scores calculated and verified</li>
                                <li style="margin: 8px 0; color: #1f2937;">âœ“ Service availability and responsiveness documented</li>
                                <li style="margin: 8px 0; color: #1f2937;">âœ“ Report generated with official ARTA metrics</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; font-size: 10px; color: #666; page-break-inside: avoid;">
                        <p style="margin: 8px 0;"><strong>Report Information:</strong> This is an official ARTA Customer Satisfaction Survey Compliance Report generated automatically from the system database.</p>
                        <p style="margin: 8px 0;"><strong>Data Source:</strong> ARTA CSS System - Firestore Database</p>
                        <p style="margin: 8px 0;"><strong>Report Period:</strong> Current data as of ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p style="margin: 8px 0;"><strong>Generated:</strong> ${new Date().toLocaleString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' })}</p>
                        <p style="margin: 8px 0; border-top: 1px solid #ddd; padding-top: 10px;">This report contains confidential information and should be handled according to organizational data security policies. For questions or clarifications, contact your ARTA system administrator.</p>
                        <p style="margin: 8px 0; color: #999; font-style: italic;">Document Type: Official ARTA Compliance Report | Classification: Internal Use</p>
                    </div>
                </div>
            `;
            
            const element = document.createElement('div');
            element.innerHTML = htmlContent;
            
            const opt = {
                margin: 10,
                filename: `ARTA-Compliance-Report-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 1.5, logging: false, useCORS: true, allowTaint: true },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                // Restore button state
                btn.innerHTML = originalText;
                btn.disabled = false;
            }).catch(err => {
                console.error('PDF generation error:', err);
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('Error generating PDF. Please try again.');
            });
        }

        /**
         * Generate comprehensive ARTA submission report using Firestore data
         */
        function generateComprehensiveReport() {
            const responses = window.allSurveyResponses || [];
            
            if (responses.length === 0) {
                alert('No survey data available to generate comprehensive report.');
                return;
            }

            // Calculate all metrics from Firestore data
            let totalSqdSum = 0, totalSqdCount = 0;
            const serviceMap = {};
            const clientTypeCounts = { Citizen: 0, Business: 0, Government: 0 };

            responses.forEach(doc => {
                const sq = doc.serviceQuality || {};
                Object.keys(sq).forEach(k => {
                    const v = Number(sq[k]);
                    if (!isNaN(v)) {
                        totalSqdSum += v;
                        totalSqdCount += 1;
                    }
                });

                const svc = (doc.serviceAvailed || 'Unknown').trim() || 'Unknown';
                const sq2 = doc.serviceQuality || {};
                if (!serviceMap[svc]) serviceMap[svc] = { sumScore: 0, countScore: 0, totalCount: 0 };
                serviceMap[svc].totalCount += 1;
                
                Object.keys(sq2).forEach(k => {
                    const v = Number(sq2[k]);
                    if (!isNaN(v)) {
                        serviceMap[svc].sumScore += v;
                        serviceMap[svc].countScore += 1;
                    }
                });

                const ctRaw = (doc.clientType || 'Unknown').toString().toLowerCase();
                if (ctRaw.includes('citizen')) clientTypeCounts.Citizen += 1;
                else if (ctRaw.includes('business')) clientTypeCounts.Business += 1;
                else if (ctRaw.includes('government')) clientTypeCounts.Government += 1;
            });

            const totalResponses = responses.length;
            const avgSqd = totalSqdCount > 0 ? (totalSqdSum / totalSqdCount).toFixed(1) : 0;
            
            const total = totalResponses;
            const pct = (n) => ((n / total) * 100).toFixed(0);
            const citizenCount = clientTypeCounts.Citizen;
            const businessCount = clientTypeCounts.Business;
            const governmentCount = clientTypeCounts.Government;
            const citizenPct = pct(clientTypeCounts.Citizen);
            const businessPct = pct(clientTypeCounts.Business);
            const governmentPct = pct(clientTypeCounts.Government);

            // Build service table rows dynamically
            let serviceTableRows = '';
            let rowIndex = 0;
            Object.keys(serviceMap).forEach(svc => {
                const service = serviceMap[svc];
                const avgScore = service.countScore > 0 ? (service.sumScore / service.countScore).toFixed(1) : 0;
                const bgColor = rowIndex % 2 === 0 ? '' : 'background: #f9f9f9;';
                serviceTableRows += `<tr style="${bgColor}"><td style="padding: 10px; border-bottom: 1px solid #ddd;">${svc}</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${service.totalCount}</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${avgScore}/5</td></tr>`;
                rowIndex++;
            });

            const htmlContent = `
                <div style="font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; background: white;">
                    <div style="text-align: center; border-bottom: 3px solid #0b296b; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="font-size: 32px; font-weight: bold; color: #0b296b; margin: 0;">ARTA Customer Satisfaction Survey</h1>
                        <h2 style="font-size: 18px; color: #2563eb; margin: 5px 0;">Comprehensive Compliance Report</h2>
                        <p style="font-size: 12px; color: #666; margin: 5px 0;">Generated: ${new Date().toLocaleString()}</p>
                    </div>

                    <div style="margin: 30px 0;">
                        <h3 style="font-size: 18px; font-weight: bold; color: #0b296b; margin-bottom: 15px; border-left: 4px solid #2563eb; padding-left: 10px;">Executive Summary</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="font-size: 13px; color: #666; font-weight: 500;">Total Responses</div>
                                <div style="font-size: 24px; font-weight: bold; color: #0b296b; margin-top: 8px;">${totalResponses}</div>
                            </div>
                            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <div style="font-size: 13px; color: #666; font-weight: 500;">Average Satisfaction (SQD)</div>
                                <div style="font-size: 24px; font-weight: bold; color: #0b296b; margin-top: 8px;">${avgSqd}/5</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin: 30px 0;">
                        <h3 style="font-size: 18px; font-weight: bold; color: #0b296b; margin-bottom: 15px; border-left: 4px solid #2563eb; padding-left: 10px;">Client Type Distribution</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                            <thead>
                                <tr style="background: #0b296b; color: white;">
                                    <th style="padding: 12px; text-align: left;">Client Type</th>
                                    <th style="padding: 12px; text-align: left;">Count</th>
                                    <th style="padding: 12px; text-align: left;">Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 10px; border-bottom: 1px solid #ddd;">Citizen</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${citizenCount}</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${citizenPct}%</td></tr>
                                <tr style="background: #f9f9f9;"><td style="padding: 10px; border-bottom: 1px solid #ddd;">Business</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${businessCount}</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${businessPct}%</td></tr>
                                <tr><td style="padding: 10px; border-bottom: 1px solid #ddd;">Government</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${governmentCount}</td><td style="padding: 10px; border-bottom: 1px solid #ddd;">${governmentPct}%</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin: 30px 0;">
                        <h3 style="font-size: 18px; font-weight: bold; color: #0b296b; margin-bottom: 15px; border-left: 4px solid #2563eb; padding-left: 10px;">Service Performance Analysis</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                            <thead>
                                <tr style="background: #0b296b; color: white;">
                                    <th style="padding: 12px; text-align: left;">Service Name</th>
                                    <th style="padding: 12px; text-align: left;">Responses</th>
                                    <th style="padding: 12px; text-align: left;">Average SQD Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${serviceTableRows}
                            </tbody>
                        </table>
                    </div>

                    <div style="margin: 30px 0;">
                        <h3 style="font-size: 18px; font-weight: bold; color: #0b296b; margin-bottom: 15px; border-left: 4px solid #2563eb; padding-left: 10px;">Recommendations for Improvement</h3>
                        <div style="padding: 10px; margin: 8px 0; background: #e3f2fd; border-left: 4px solid #2196f3;">âœ“ Maintain high service quality standards for all services</div>
                        <div style="padding: 10px; margin: 8px 0; background: #e3f2fd; border-left: 4px solid #2196f3;">âœ“ Analyze low-performing services and implement improvements</div>
                        <div style="padding: 10px; margin: 8px 0; background: #e3f2fd; border-left: 4px solid #2196f3;">âœ“ Continue engaging with citizen feedback for service improvement</div>
                    </div>

                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; text-align: center;">
                        <p><strong>Report Compliance Status:</strong> ARTA-Compliant</p>
                        <p>This report is automatically generated by the ARTA CSS System and meets all official ARTA submission standards.</p>
                    </div>
                </div>
            `;
            
            const element = document.createElement('div');
            element.innerHTML = htmlContent;
            
            const opt = {
                margin: 10,
                filename: `ARTA-Comprehensive-Report-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };
            
            html2pdf().set(opt).from(element).save();
        }
        // Add Question Button
        const addQuestionBtn = document.getElementById('addQuestionBtn');
        if (addQuestionBtn) {
            addQuestionBtn.addEventListener('click', function() {
                openAddQuestionModal();
            });
        }

        // Setup Questions Button - Load default survey questions
        const setupQuestionsBtn = document.getElementById('setupQuestionsBtn');
        if (setupQuestionsBtn) {
            setupQuestionsBtn.addEventListener('click', function() {
                if (confirm('This will load all default ARTA survey questions into Firestore. Existing questions will be skipped. Continue?')) {
                    // Use the modular-safe initializer below (works with getFirestore)
                    initializeDefaultSurveyQuestionsModular();
                }
            });
        }

        // Edit Question Form Submission
        const editQuestionForm = document.getElementById('editQuestionForm');
        if (editQuestionForm) {
            editQuestionForm.addEventListener('submit', saveEditedQuestion);
        }

        // Close Edit Modal Button
        const closeEditModal = document.getElementById('closeEditModal');
        if (closeEditModal) {
            closeEditModal.addEventListener('click', closeEditQuestionModal);
        }

        // Add Question Form Submission
        const addQuestionForm = document.getElementById('addQuestionForm');
        if (addQuestionForm) {
            addQuestionForm.addEventListener('submit', addNewQuestion);
        }

        // Close Add Modal Button
        const closeAddModal = document.getElementById('closeAddModal');
        if (closeAddModal) {
            closeAddModal.addEventListener('click', closeAddQuestionModal);
        }

        // --- Event Listeners ---
        
        // 1. Login Form Submission with Validation
        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Clear previous errors
            clearLoginErrors();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            // Validation
            let hasError = false;
            
            // Email validation
            if (!email) {
                showFieldError('emailError', 'Email is required');
                emailInput.classList.add('border-red-500');
                hasError = true;
            } else if (!isValidEmail(email)) {
                showFieldError('emailError', 'Please enter a valid email address');
                emailInput.classList.add('border-red-500');
                hasError = true;
            }
            
            // Password validation
            if (!password) {
                showFieldError('passwordError', 'Password is required');
                passwordInput.classList.add('border-red-500');
                hasError = true;
            } else if (password.length < 6) {
                showFieldError('passwordError', 'Password must be at least 6 characters');
                passwordInput.classList.add('border-red-500');
                hasError = true;
            }
            
            if (hasError) return;
            
            // Show loading overlay
            document.body.appendChild(loadingOverlay);
            
            try {
                // Validate admin credentials with Firebase
                const result = await validateAdminLogin(email, password);
                console.log('validateAdminLogin result:', result);
                
                if (result.success) {
                    // Store user session
                    sessionStorage.setItem('adminUser', JSON.stringify(result.user));
                    sessionStorage.setItem('adminSessionTime', new Date().getTime());
                    
                    // Hide loading overlay and show dashboard
                    if (document.body.contains(loadingOverlay)) {
                        document.body.removeChild(loadingOverlay);
                    }
                    
                    // Update user menu button with actual role
                    const userMenuButton = document.getElementById('userMenuButton');
                    if (userMenuButton) {
                        const roleText = result.user.role ? 
                            result.user.role.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') :
                            'Admin';
                        const buttonSpan = userMenuButton.querySelector('span');
                        if (buttonSpan) {
                            buttonSpan.textContent = roleText;
                        }
                    }
                    
                    // Update navbar access control based on role
                    if (result.user.role) {
                        updateNavbarAccessControl(result.user.role);
                    }
                    
                    // Show success message
                    const loginError = document.getElementById('loginError');
                    const roleDisplay = result.user.role ? 
                        result.user.role.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') :
                        'Admin';
                    loginError.textContent = `Welcome, ${result.user.name}! (${roleDisplay})`;
                    loginError.classList.remove('hidden');
                    loginError.classList.remove('text-red-600');
                    loginError.classList.add('text-green-600');
                    
                    // Show toast notification
                    showToast(`Logged in as ${roleDisplay}`, 'success', 2000);
                    
                    setTimeout(() => {
                        toggleAppView(true);
                    }, 500);
                } else {
                    // Show error message
                    if (document.body.contains(loadingOverlay)) {
                        document.body.removeChild(loadingOverlay);
                    }
                    
                    showFieldError('loginError', result.message);
                    document.getElementById('loginError').classList.add('text-red-600');
                    
                    // Highlight password field for general auth errors
                    if (result.message.includes('Invalid') || result.message.includes('password')) {
                        passwordInput.classList.add('border-red-500');
                    }
                }
            } catch (error) {
                console.error('Login error (unexpected):', error);
                if (document.body.contains(loadingOverlay)) {
                    document.body.removeChild(loadingOverlay);
                }
                // Surface the underlying message when possible to aid debugging.
                const message = (error && (error.message || error.code)) ? (error.message || error.code) : 'An error occurred. Please try again.';
                showFieldError('loginError', message);
                document.getElementById('loginError').classList.add('text-red-600');
            }
        });

        // Helper function to validate email format
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Helper function to show field errors
        function showFieldError(errorElementId, message) {
            const errorElement = document.getElementById(errorElementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }
        }

        // Helper function to clear all login errors
        function clearLoginErrors() {
            const emailError = document.getElementById('emailError');
            const passwordError = document.getElementById('passwordError');
            const loginError = document.getElementById('loginError');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            if (emailError) emailError.classList.add('hidden');
            if (passwordError) passwordError.classList.add('hidden');
            if (loginError) loginError.classList.add('hidden');
            emailInput.classList.remove('border-red-500');
            passwordInput.classList.remove('border-red-500');
            emailInput.classList.add('border-gray-300');
            passwordInput.classList.add('border-gray-300');
        }

        // Clear errors when user starts typing
        document.getElementById('email').addEventListener('input', function() {
            this.classList.remove('border-red-500');
            this.classList.add('border-gray-300');
            document.getElementById('emailError').classList.add('hidden');
        });

        document.getElementById('password').addEventListener('input', function() {
            this.classList.remove('border-red-500');
            this.classList.add('border-gray-300');
            document.getElementById('passwordError').classList.add('hidden');
        });

        // 2. Sidebar Navigation Clicks - with access control
        navLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const viewId = this.dataset.view;
                
                // Check if user has access to this tab
                try {
                    const adminUserJson = sessionStorage.getItem('adminUser');
                    if (adminUserJson) {
                        const adminUser = JSON.parse(adminUserJson);
                        const allowedTabs = rolePermissions[adminUser.role] || [];
                        
                        if (!allowedTabs.includes(viewId)) {
                            showToast(`You don't have access to this section`, 'error', 3000);
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('Could not check access control:', e);
                }
                
                navigateTo(viewId);
            });
        });

        // 3. Mobile Menu Toggle
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
        });

        // 4. NEW: Show Add User Form (from User Management)
        showAddUserBtn.addEventListener('click', function() {
            navigateTo('add-user-form');
        });

        // 5. NEW: Go Back to User Management (from Add User Form)
        goBackBtn.addEventListener('click', function() {
            navigateTo('user-management');
        });

        // 6. NEW: Add User Form Submission with Validation -> Invite flow (Firebase-only)
        addUserForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            if (!validateAddUserForm()) return;

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;

            // Show loading overlay
            document.body.appendChild(loadingOverlay);

            try {
                const inviteResult = await inviteUser({ email, first_name: firstName, last_name: lastName, role });

                if (inviteResult.success) {
                    // Show success modal with credentials
                    showInviteSuccessModal(email, inviteResult.tempPassword);
                    
                    // Clear form
                    addUserForm.reset();
                    clearAddUserErrors();
                } else {
                    showToast('Failed to invite user: ' + (inviteResult.message || 'Unknown error'), 'error', 4000);
                }
            } catch (err) {
                console.error('Invite error:', err);
                alert('Error inviting user: ' + (err && err.message ? err.message : err));
            } finally {
                if (document.body.contains(loadingOverlay)) document.body.removeChild(loadingOverlay);
            }
        });

        // Helper: Show invite success modal with credentials
        function showInviteSuccessModal(email, tempPassword) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('inviteSuccessModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'inviteSuccessModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
                        <div class="flex justify-center mb-4">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2 text-center">User Invited Successfully!</h2>
                        <p class="text-gray-600 mb-6 text-center">Share these credentials with the new user.</p>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <p class="text-sm text-gray-700 mb-3"><strong>Email:</strong> <span id="inviteEmail" class="font-mono text-blue-600"></span></p>
                            <p class="text-sm text-gray-700 mb-3"><strong>Temporary Password:</strong> <span id="inviteTempPassword" class="font-mono text-blue-600 break-all"></span></p>
                            <button id="copyPasswordBtn" class="text-blue-600 hover:text-blue-800 text-sm font-semibold mt-2 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                Copy Password
                            </button>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                            <p class="text-sm font-semibold text-yellow-800 mb-2">âš ï¸ Next Steps:</p>
                            <ul class="text-sm text-yellow-700 space-y-2 list-disc list-inside">
                                <li>Share email and password with the new user</li>
                                <li>User logs in and can change password</li>
                                <li>Go to User Management and click "Activate" button</li>
                                <li>User is now active and can use the system</li>
                            </ul>
                        </div>
                        
                        <div class="flex gap-4">
                            <button id="closeInviteModalBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-150">
                                Done
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('inviteEmail').textContent = email;
            document.getElementById('inviteTempPassword').textContent = tempPassword;
            modal.classList.remove('hidden');

            // Copy password handler
            document.getElementById('copyPasswordBtn').onclick = function() {
                const passwordText = document.getElementById('inviteTempPassword').textContent;
                navigator.clipboard.writeText(passwordText).then(() => {
                    const btn = this;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 4a2 2 0 012-2 1 1 0 000 2h12a1 1 0 100-2 2 2 0 00-2 2v12a2 2 0 002 2 1 1 0 100-2h-1.535A3 3 0 0112.817 16H5a2 2 0 01-2-2V4zm12.982 3.517a1 1 0 00-1.414-1.414L10.5 9.172 9.707 8.38a1 1 0 00-1.414 1.414l1.414 1.414 4.243-4.243z" clip-rule="evenodd"></path></svg> Copied!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                });
            };

            // Close modal handler
            document.getElementById('closeInviteModalBtn').onclick = function() {
                modal.classList.add('hidden');
                // Unsubscribe and reload to refresh the table
                if (window._adminUsersUnsub && typeof window._adminUsersUnsub === 'function') {
                    try { window._adminUsersUnsub(); } catch (e) { }
                }
                if (window._pendingInvitesUnsub && typeof window._pendingInvitesUnsub === 'function') {
                    try { window._pendingInvitesUnsub(); } catch (e) { }
                }
                navigateTo('user-management');
            };
        }

        // Helper: generate a secure temporary password
        // Invite user: Use Cloud Function to create Auth user and admin_users document
        // Helper: Generate random secure password that meets Firebase requirements
        function generateRandomPassword() {
            // Firebase requires at least 6 characters, but we'll use stronger requirements
            // Must include: uppercase, lowercase, numbers, special characters
            const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const lowercase = 'abcdefghijklmnopqrstuvwxyz';
            const numbers = '0123456789';
            const specials = '!@#$%^&*';
            
            let password = '';
            // Ensure at least one of each required type
            password += uppercase[Math.floor(Math.random() * uppercase.length)];
            password += lowercase[Math.floor(Math.random() * lowercase.length)];
            password += numbers[Math.floor(Math.random() * numbers.length)];
            password += specials[Math.floor(Math.random() * specials.length)];
            
            // Fill the rest with random characters from all types
            const allChars = uppercase + lowercase + numbers + specials;
            for (let i = password.length; i < 12; i++) {
                password += allChars[Math.floor(Math.random() * allChars.length)];
            }
            
            // Shuffle the password
            return password.split('').sort(() => Math.random() - 0.5).join('');
        }

        // Invite user: Firebase-only - Creates Auth user immediately + pending invite
        async function inviteUser({ email, first_name, last_name, role }) {
            try {
                if (!window.db || !window.auth) {
                    return { success: false, message: 'Firebase not initialized' };
                }

                // Check if current user is super_admin
                const currentUser = window.auth.currentUser;
                if (!currentUser) {
                    return { success: false, message: 'You must be logged in to invite users' };
                }

                const adminUsersRef = window.collection(window.db, 'admin_users');
                const currentUserDoc = await window.getDoc(window.doc(window.db, 'admin_users', currentUser.uid));
                
                if (!currentUserDoc.exists() || currentUserDoc.data().role !== 'super_admin') {
                    return { success: false, message: 'Only super_admin can invite users' };
                }

                // Check if email already exists in admin_users
                const existingQuery = window.query(adminUsersRef, window.where('email', '==', email));
                const existingDocs = await window.getDocs(existingQuery);

                if (!existingDocs.empty) {
                    return { success: false, message: 'This email is already registered as an admin user.' };
                }

                // Generate random password
                const tempPassword = generateRandomPassword();

                // Step 1: Create Firebase Auth user immediately with temp password
                let newUID = null;
                try {
                    const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, tempPassword);
                    newUID = userCredential.user.uid;
                    console.log('Firebase Auth user created:', newUID);
                } catch (authError) {
                    if (authError.code === 'auth/email-already-in-use') {
                        return { success: false, message: 'This email is already registered in Firebase. Please use a different email.' };
                    }
                    throw authError;
                }

                // Step 2: Create pending invite in Firestore
                const invitesRef = window.collection(window.db, 'pending_invites');
                const newInvite = await window.addDoc(invitesRef, {
                    email: email,
                    first_name: first_name,
                    last_name: last_name,
                    role: role,
                    temp_password: tempPassword,
                    status: 'pending',
                    firebase_uid: newUID,
                    created_at: window.serverTimestamp(),
                    created_by: window.auth.currentUser ? window.auth.currentUser.uid : 'unknown'
                });

                console.log('Pending invite created:', newInvite.id);

                return {
                    success: true,
                    uid: newInvite.id,
                    tempPassword: tempPassword,
                    message: 'User invited successfully'
                };
            } catch (error) {
                console.error('inviteUser error:', error);
                return { 
                    success: false, 
                    message: error.message || 'Failed to invite user'
                };
            }
        }

        // Load admin users AND pending invites from Firestore
        function loadAdminUsers() {
            try {
                // Unsubscribe existing listeners
                if (window._adminUsersUnsub && typeof window._adminUsersUnsub === 'function') {
                    try { window._adminUsersUnsub(); } catch (e) { console.warn('Failed to unsubscribe admin_users listener', e); }
                }
                if (window._pendingInvitesUnsub && typeof window._pendingInvitesUnsub === 'function') {
                    try { window._pendingInvitesUnsub(); } catch (e) { console.warn('Failed to unsubscribe pending_invites listener', e); }
                }

                // Keep track of both collections
                let adminUsersRows = [];
                let pendingInvitesRows = [];
                let adminUsersLoaded = false;
                let pendingInvitesLoaded = false;

                const combineAndRender = () => {
                    if (adminUsersLoaded && pendingInvitesLoaded) {
                        const allRows = [
                            ...adminUsersRows.map(r => ({ ...r, type: 'admin' })),
                            ...pendingInvitesRows.map(r => ({ ...r, type: 'pending_invite' }))
                        ];
                        console.log('[admin.html] Combined rows: ', allRows.length);
                        renderAdminUsers(allRows);
                    }
                };

                // Listen to admin_users
                const usersRef = window.collection(window.db, 'admin_users');
                window._adminUsersUnsub = window.onSnapshot(usersRef, (snapshot) => {
                    console.log('[admin.html] admin_users snapshot received, docCount=', snapshot.size);
                    adminUsersRows = [];
                    snapshot.forEach(docSnap => {
                        const d = docSnap.data();
                        adminUsersRows.push({ id: docSnap.id, ...d });
                    });
                    adminUsersLoaded = true;
                    combineAndRender();
                }, (err) => {
                    console.error('[admin.html] admin_users snapshot error', err);
                    const tbody = document.querySelector('#user-management table tbody');
                    if (tbody) {
                        const msg = (err && err.code === 'permission-denied') ? 'Permission denied: check Firestore rules.' : 'Error loading admin users.';
                        tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-red-500">${msg}</td></tr>`;
                    }
                });

                // Listen to pending_invites
                const invitesRef = window.collection(window.db, 'pending_invites');
                window._pendingInvitesUnsub = window.onSnapshot(invitesRef, (snapshot) => {
                    console.log('[admin.html] pending_invites snapshot received, docCount=', snapshot.size);
                    pendingInvitesRows = [];
                    snapshot.forEach(docSnap => {
                        const d = docSnap.data();
                        pendingInvitesRows.push({ id: docSnap.id, ...d });
                    });
                    pendingInvitesLoaded = true;
                    combineAndRender();
                }, (err) => {
                    console.error('[admin.html] pending_invites snapshot error', err);
                    // For pending_invites, just log the error and mark as loaded
                    console.warn('Could not load pending_invites, but continuing with admin_users');
                    pendingInvitesLoaded = true;
                    combineAndRender();
                });
            } catch (err) {
                console.error('loadAdminUsers error', err);
            }
        }

        function renderAdminUsers(users) {
            const tbody = document.querySelector('#user-management table tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No admin users or pending invites found</td></tr>';
                return;
            }

            users.forEach(u => {
                const fullName = (u.first_name && u.last_name) 
                    ? `${u.first_name} ${u.last_name}` 
                    : (u.name || '');
                
                const roleBadge = `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${u.role || 'admin'}</span>`;
                
                let statusBadge = '';
                let actionButtons = '';

                if (u.type === 'pending_invite') {
                    // Pending invite - show as Pending with Activate button
                    statusBadge = '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>';
                    actionButtons = `
                        <button class="activate-user-btn text-green-600 hover:text-green-800 text-xs px-2 py-1 rounded flex items-center gap-1" data-type="pending_invite" data-id="${u.id}" data-email="${u.email}" data-password="${u.temp_password}" title="Activate this invite">
                            âœ“ Activate
                        </button>
                        <button class="delete-admin-btn text-red-600 hover:text-red-800" data-type="pending_invite" data-id="${u.id}"><i data-lucide="trash" class="w-5 h-5"></i></button>
                    `;
                } else {
                    // Active admin user
                    const userStatus = u.status || (u.isActive ? 'active' : 'inactive');
                    statusBadge = userStatus === 'active' 
                        ? '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>' 
                        : '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Inactive</span>';
                    actionButtons = `
                        <button class="delete-admin-btn text-red-600 hover:text-red-800" data-type="admin" data-id="${u.id}"><i data-lucide="trash" class="w-5 h-5"></i></button>
                    `;
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${fullName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${u.email || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${roleBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2 flex gap-2">
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Recreate lucide icons for dynamic buttons
            if (window.lucide) lucide.createIcons();

            // Activate user handlers
            document.querySelectorAll('.activate-user-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const inviteId = this.dataset.id;
                    const email = this.dataset.email;
                    const tempPassword = this.dataset.password;
                    
                    showConfirmationModal(
                        'Activate User',
                        `Are you sure you want to activate this user? They will be able to log in.`,
                        async () => {
                            try {
                                showLoader('Activating user...');
                                
                                // Get invite data
                                const inviteRef = window.doc(window.db, 'pending_invites', inviteId);
                                const inviteSnap = await window.getDoc(inviteRef);
                                if (!inviteSnap.exists()) {
                                    throw new Error('Invite not found');
                                }
                                const inviteData = inviteSnap.data();
                                
                                // Get the Firebase UID from the pending invite
                                // (The Firebase Auth user was already created during invitation)
                                const newUID = inviteData.firebase_uid;
                                if (!newUID) {
                                    throw new Error('Firebase UID not found in invite');
                                }
                                
                                console.log('Activating user with UID:', newUID);
                                console.log('Current user UID:', window.auth.currentUser.uid);
                                console.log('Creating admin_users document with role:', inviteData.role);
                                
                                // Create admin_users document with active status
                                const adminUsersRef = window.collection(window.db, 'admin_users');
                                try {
                                    await window.setDoc(window.doc(adminUsersRef, newUID), {
                                        email: inviteData.email,
                                        first_name: inviteData.first_name,
                                        last_name: inviteData.last_name,
                                        role: inviteData.role,
                                        status: 'active',
                                        created_at: window.serverTimestamp(),
                                        created_by: window.auth.currentUser.uid,
                                        activated_at: window.serverTimestamp(),
                                        activated_by: window.auth.currentUser.uid
                                    });
                                    console.log('admin_users document created:', newUID);
                                } catch (docError) {
                                    console.error('Error creating admin_users document:', docError);
                                    throw docError;
                                }
                                
                                // Delete pending invite
                                try {
                                    await window.deleteDoc(inviteRef);
                                    console.log('Pending invite deleted:', inviteId);
                                } catch (deleteError) {
                                    console.error('Error deleting pending_invite:', deleteError);
                                    throw deleteError;
                                }
                                
                                hideLoader();
                                showToast(`User activated successfully! Email: ${email}`, 'success', 3000);
                            } catch (error) {
                                hideLoader();
                                console.error('Error activating user:', error);
                                
                                // Handle specific error codes
                                if (error.message && error.message.includes('Invite not found')) {
                                    showToast('Error: The pending invite could not be found. It may have already been deleted or activated.', 'error', 4000);
                                } else if (error.code === 'permission-denied' || (error.message && error.message.includes('permission'))) {
                                    showToast('Error: Permission denied. Make sure you are a super_admin.', 'error', 4000);
                                } else if (error.message && error.message.includes('Firebase UID')) {
                                    showToast('Error: ' + error.message + '. Please contact your system administrator.', 'error', 4000);
                                } else {
                                    showToast(`Error: ${error.message || 'Could not activate user'}`, 'error', 4000);
                                }
                            }
                        }
                    );
                });
            });

            // Delete handlers
            document.querySelectorAll('.delete-admin-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const uid = this.dataset.id;
                    const type = this.dataset.type;
                    const collectionName = type === 'pending_invite' ? 'pending_invites' : 'admin_users';
                    
                    showConfirmationModal('Delete', `Are you sure you want to delete this ${type === 'pending_invite' ? 'invite' : 'user'}?`, async () => {
                        try {
                            await window.deleteDoc(window.doc(window.db, collectionName, uid));
                            console.log(`Deleted ${collectionName}/${uid}`);
                        } catch (e) {
                            console.error('Error deleting:', e);
                            showToast('Failed to delete.', 'error', 3000);
                        }
                    });
                });
            });
        }

        // Start listening for admin users only after auth state is known (avoid permission-denied when unauthenticated)
        try {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    try { loadAdminUsers(); } catch (e) { console.warn('Could not start admin_users listener after sign-in', e); }
                } else {
                    // If user signed out, clear any existing table and unsubscribe
                    const tbody = document.querySelector('#user-management table tbody');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Please sign in to view admin users</td></tr>';
                    if (window._adminUsersUnsub && typeof window._adminUsersUnsub === 'function') {
                        try { window._adminUsersUnsub(); } catch (e) { /* ignore */ }
                        window._adminUsersUnsub = null;
                    }
                }
            });
        } catch (e) { console.warn('Could not attach auth state listener for admin_users', e); }

        // 7. Export CSV Button
        const exportAllCsvBtn = document.getElementById('exportAllCsvBtn');
        if (exportAllCsvBtn) {
            exportAllCsvBtn.addEventListener('click', function(event) {
                event.preventDefault();
                showConfirmationModal(
                    'Export Survey Data',
                    'This will download all survey responses as a CSV file. Do you want to proceed?',
                    exportToCSV
                );
            });
        }

        // 8. Download PDF Button
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        if (downloadPdfBtn) {
            downloadPdfBtn.addEventListener('click', function(event) {
                event.preventDefault();
                showConfirmationModal(
                    'Generate ARTA Compliance Report',
                    'This will generate the ARTA Compliance Report as a PDF. Do you want to proceed?',
                    exportToPDF
                );
            });
        }

        // 9. Generate Comprehensive Report Button
        const generateReportBtn = document.getElementById('generateReportBtn');
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', function(event) {
                event.preventDefault();
                showConfirmationModal(
                    'Generate Comprehensive ARTA Report',
                    'This will create a comprehensive ARTA submission report. Do you want to proceed?',
                    generateComprehensiveReport
                );
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Show login view by default (do not bypass login)
            toggleAppView(false);
            
            // Initialize survey questions from Firestore with real-time listener
            initializeSurveyQuestionsFromFirestore();
            
            // Ensure default questions exist when admin loads (modular-safe)
            // We call this after the real-time listener is set so UI updates automatically
            ensureDefaultQuestionsExist();
        });

        // Ensure lucide icons are created on first load for the login view
        lucide.createIcons();

    </script>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="hidden-modal">
        <div class="modal-backdrop" id="forgotPasswordBackdrop"></div>
        <div class="modal-content">
            <div class="modal-header">Forgot Password</div>
            <div class="modal-body">
                <p class="mb-4">If you have forgotten your password, please contact the Super Admin for assistance:</p>
                <p>Email: <a href="mailto:admin@arta.gov.ph" class="text-blue-600 hover:text-blue-500">admin@arta.gov.ph</a></p>
                <p>Hotline: +63 (2) 8123-ARTA</p>
            </div>
            <div class="modal-footer">
                <button type="button" id="closeForgotPasswordModal" class="modal-btn modal-btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutConfirmModal" class="hidden-modal">
        <div class="modal-backdrop" id="logoutConfirmBackdrop"></div>
        <div class="modal-content">
            <div class="modal-header">Confirm Logout</div>
            <div class="modal-body">
                <p>Are you sure you want to log out? Any unsaved changes may be lost.</p>
            </div>
            <div class="modal-footer">
                <button type="button" id="cancelLogoutBtn" class="modal-btn modal-btn-secondary">Cancel</button>
                <button type="button" id="confirmLogoutBtn" class="modal-btn modal-btn-danger">Yes, Log Out</button>
            </div>
        </div>
    </div>

    <script src="./rbac.js"></script>
</body>
</html>